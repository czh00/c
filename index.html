<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能桌面小工具</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 預設顏色變數，會由 JS 載入設定 */
        }
        html, body {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            font-weight: bold;
            background-color: var(--bg-primary, #000000); /* 改為純黑背景 */
            color: var(--text-primary, #F3F4F6);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- 通用 Widget 容器樣式 --- */
        .widget-container {
            position: absolute;
            border: 2px dashed transparent;
            /* 移除 top 和 left 的 transition，避免拖曳延遲 */
            transition: border-color 0.3s;
            box-sizing: border-box; user-select: none;
            display: flex; flex-direction: column;
            background-color: transparent; z-index: 10;
            padding: 0;
            transform-origin: top left;
        }
        .widget-container.edit-mode:not(:has(.control-handle:hover)) { cursor: zoom-in; }
        .widget-container.edit-mode:not(:has(.control-handle:hover)):active { cursor: zoom-out; }
        .widget-container.edit-mode { border-color: rgba(0, 255, 255, 0.5); }
        .widget-content-wrapper {
            width: 100%;
            height: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative; 
        }
        .widget-content-wrapper > main { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            min-height: 0;
        }

        /* --- 月曆 spezifische樣式 --- */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0; margin: 0;
            position: relative;
            z-index: 2;
        }
        .calendar-title {
            font-weight: 700;
            letter-spacing: 0.025em;
            padding: 0; margin: 0;
            cursor: pointer;
            color: var(--year-color);
            transition: color 150ms cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
             /* 修改：改為 flex 佈局以對齊 SVG 和文字 */
            display: flex;
            align-items: center; /* 改為置中對齊 */
            gap: 4px;
            height: 30px; /* 給定一個固定高度以確保對齊一致 */
        }
        .calendar-title:hover {
            color: #a5b4fc;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            padding: 0; margin: 0;
            flex-shrink: 0;
        }
        .calendar-nav-arrow {
            padding: 0; margin: 0;
            transition: color 150ms cubic-bezier(0.4, 0, 0.2, 1), background-color 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .calendar-nav-today {
            font-weight: 700;
            align-items: center;
            padding: 0; margin: 0;
            transition: color 150ms cubic-bezier(0.4, 0, 0.2, 1), background-color 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0; }
        .calendar-day { padding: 0.25rem; margin: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; font-size: 0.9em; border: 1px solid #555; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; background-color: transparent !important; z-index: 1; position: relative; overflow: hidden; }
        .calendar-day:not(.edit-mode-active):hover { background-color: var(--bg-hover); cursor: pointer; }
        /* 當月相圖示顯示時的新版面配置 */
        .calendar-day.with-moon-icon {
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }
        .day-text-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1; /* 讓文字內容區塊佔滿可用空間 */
            min-width: 0;  /* 允許文字區塊縮小並截斷超長文字 */
        }
        .day-moon-container {
            flex-shrink: 0;
            margin-left: 0.25rem;
        }

        .day-header { border: 1px solid #555; background-color: var(--bg-secondary); color: var(--week-color); font-size: 0.9em; padding: 0.25rem; text-align: center; font-weight: 600; }
        .today { background-color: var(--today-bg); color: white; box-shadow: 0 0 10px 1px var(--today-border); border-radius: 0.5em; }
        /* 修改：新增 opacity 屬性來淡化非當月日期 */
        .other-month { color: var(--text-muted); opacity: 0.4; }
        .day-number-wrapper { margin-bottom: 2px; } /* 修改：為日期數字SVG新增的容器 */
        .lunar-date { font-size: 1.2em; color: var(--lunar-color); line-height: 1; }
        .holiday-text, .solarterm-text { font-size: 1.2em; font-weight: 500; cursor: help; line-height: 1; }
        .holiday-text { color: var(--holiday-color); }
        .solarterm-text { color: var(--solarterm-color); }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .space-y-px > :not([hidden]) ~ :not([hidden]) { margin-top: 1px; }
        .today .lunar-date, .today .holiday-text, .today .solarterm-text { color: #C7D2FE; }
        #calendar-body, #moon-calendar-body { flex-grow: 1; display: grid; min-height: 0; }
        #calendar-container main, #moon-phase-container main { overflow: hidden; }
        .background-month { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 900; color: var(--month-color); z-index: 1; user-select: none; opacity: 0.8; line-height: 0.8; pointer-events: none; }
         /* 修改：新增 LED 單位文字樣式 */
        .led-text-unit {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            font-weight: bold;
            display: inline-block;
            vertical-align: baseline;
            padding-left: 4px;
            line-height: 1;
            font-size: 20px;
            color: var(--year-color);
        }
        .led-text-unit-modal {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            font-weight: bold;
            display: inline-block;
            vertical-align: baseline;
            padding: 0 4px;
            line-height: 1;
            font-size: 22px;
            color: white;
        }
        #modal-gregorian-date {
             display: flex;
             align-items: flex-end;
             justify-content: center;
             flex-wrap: wrap;
             gap: 2px;
        }
        #modal-lunar-date {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .countdown-text-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* 控制文字和LED數字的間距 */
        }
        .countdown-text-container svg {
             vertical-align: middle; /* 確保SVG和文字對齊 */
        }

        /* --- LED 時鐘 spezifische樣式 --- */
        #led-clock-container svg { width: 100%; height: 100%; overflow: visible; }
        #led-clock-container .segment { transition: opacity 0.2s ease-in-out; }
        #led-clock-container .segment-h { fill: var(--led-hour-color); }
        #led-clock-container .segment-m { fill: var(--led-minute-color); }
        #led-clock-container .segment-s { fill: var(--led-second-color); }
        #led-clock-container .colon { fill: var(--led-colon-color); }
        #led-clock-container .period-text { fill: var(--led-period-color); font-size: 50px; }
        .period-text { position: absolute; top: 0; right: -10vw; }

        /* --- 指針時鐘 spezifische樣式 --- */
        #analog-clock-container { border-radius: 50%; }
        #analog-clock-container .resize-handle-w, #analog-clock-container .resize-handle-h { display: none !important; }
        #analog-clock-container main { aspect-ratio: 1 / 1; border-radius: 50%; background-color: var(--analog-face-color); clip-path: circle(50%); overflow: hidden;}
        .analog-clock-face { position: relative; width: 100%; height: 100%; }
        .analog-hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom; background-color: var(--analog-hand-color); border-radius: 50% 50% 0 0; }
        .hour-hand { width: 1.5%; height: 25%; z-index: 5; }
        .minute-hand { width: 1%; height: 40%; z-index: 6; }
        .second-hand { width: 0.5%; height: 45%; background-color: var(--analog-second-hand-color); z-index: 7; }
        .analog-pivot { position: absolute; top: 50%; left: 50%; width: 3%; height: 3%; background-color: var(--analog-second-hand-color); border-radius: 50%; transform: translate(-50%, -50%); z-index: 8; }
        .ticks-container { width: 100%; height: 100%; z-index: 2; }
        .tick-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .tick { position: absolute; background-color: var(--analog-tick-color); }
        .tick-minute { top: 1%; left: 49.75%; width: 0.5%; height: 2%; border-radius: 1px; }
        .tick-hour { top: 1%; left: 49.5%; width: 1%; height: 4%; border-radius: 1px; }
        /* 修改：調整指針時鐘數字樣式以配合 LED 風格 */
        .number {
            position: absolute;
            top: 6%;
            left: 0;
            width: 100%;
            height: 10%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .number > div {
            transform: rotate(calc(-1 * var(--rotation)));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- 跑馬燈 spezifische樣式 --- */
        .marquee-widget main { display: flex; align-items: center; justify-content: flex-start; width: 100%; height: 100%; overflow: hidden; transform: translateZ(0); -webkit-transform: translateZ(0); }
        .marquee-edit-indicator {
            position: absolute;
            top: -10px;
            left: -10px;
            background-color: rgba(0, 255, 255, 0.8);
            color: black;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 101;
            transform-origin: center;
        }
        .widget-container.edit-mode .marquee-edit-indicator {
            display: flex;
        }
        .marquee-inner { display: flex; width: fit-content; height: fit-content; will-change: transform; transform: translateZ(0); font-variant-numeric: tabular-nums; font-feature-settings: 'tnum'; -webkit-backface-visibility: hidden; backface-visibility: hidden; perspective: 1000px; margin-right: auto; }
        .marquee-text-instance { white-space: nowrap; flex-shrink: 0; line-height: 1; }
        
        /* --- 跑馬燈內容對齊修正 --- */
        .marquee-text-instance > span {
            vertical-align: middle; /* 讓所有項目垂直置中 */
        }
        /* 註解：已移除 .marquee-plain-text 的特定字體大小規則，以確保所有文字（包括 LED 數字和一般文字）大小一致 */
        .marquee-text-instance svg {
            vertical-align: middle;
            /* 2024-09-14: 新增 transform 屬性微調垂直位置 */
            /* 由於 SVG 的基準線與中文字體不同，導致視覺上偏下 */
            /* 使用 translateY 向上移動一點距離 (負值表示向上) */
            /* 您可以微調 -5% 這個值以達到最理想的對齊效果 */
            transform: translateY(-7%);
        }

        /* --- 月相Widget樣式 --- */
        #moon-phase-container .calendar-day.selected { border-color: var(--moon-highlight-color); box-shadow: 0 0 5px var(--moon-highlight-color); border-radius: 0.375rem; }
        .moon-icon-small svg { width: 100%; height: auto; max-width: 28px; margin: 0 auto; }
        #moon-detail-icon svg { width: 120px; height: 120px; }

        /* --- 控制點樣式 --- */
        .control-handle { position: absolute; background-color: rgba(79, 70, 229, 0.8); border-radius: 50%; display: none; z-index: 100; }
        .widget-container.edit-mode .control-handle { display: block; }
        .move-handle { width: 28px; height: 28px; top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: move; padding: 4px; border-radius: 6px; align-items: center; justify-content: center; }
        .widget-container.edit-mode .move-handle { display: flex; }
        .resize-handle-w { width: 8px; height: 50px; top: 50%; right: -4px; transform: translateY(-50%); border-radius: 4px; cursor: ew-resize; }
        .resize-handle-h { width: 50px; height: 8px; bottom: -4px; left: 50%; transform: translateX(-50%); border-radius: 4px; cursor: ns-resize; }

        /* --- Modal 彈出視窗樣式 --- */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: #1F2937; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; transform: scale(0.95); transition: transform 0.3s ease; display: flex; flex-direction: column; }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        .yi-tag { background-color: var(--yi-color); color: var(--bg-primary); }
        .ji-tag { background-color: var(--ji-color); color: white; }
        .yi-text, .ji-text { font-size: 0.8em; padding: 0; border-radius: 0; cursor: help; }
        .param-list { list-style: none; padding-left: 0; margin-top: 1rem; color: #d1d5db; }
        .param-item { font-size: 0.875rem; margin-bottom: 0.5rem; }
        .param-item strong { color: #f7fafc; min-width: 120px; display: inline-block; }
        .param-group-title { font-weight: bold; color: #a5b4fc; margin-top: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #4b5563; }
        .yi-text { color: var(--yi-color); background-color: rgba(52, 211, 153, 0.1); }
        .ji-text { color: var(--ji-color); background-color: rgba(248, 113, 113, 0.1); }
        .today .yi-text, .today .ji-text { background-color: rgba(200, 210, 254, 0.2); }
        #month-year-picker { max-width: 320px; }
        #month-year-picker .year-nav { display: flex; justify-content: space-between; align-items: center; }
        #month-year-picker .month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        #month-year-picker .month-cell { padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #month-year-picker .month-cell:hover { background-color: var(--bg-hover); }
        #month-year-picker .month-cell.selected { background-color: #4f46e5; color: white; }
        /* --- UI 按鈕與工具列 --- */
        .action-buttons { position: fixed; bottom: 1rem; right: 1rem; display: flex; gap: 0.5rem; z-index: 1000; opacity: 1; transition: opacity 0.5s ease-in-out; }
        .action-buttons.hidden { opacity: 0; pointer-events: none; }
        .action-button { background-color: transparent; border: 1px solid rgba(75, 85, 99, 0.8); color: #d1d5db; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; box-shadow: none; }
        .action-button:hover { background-color: rgba(75, 85, 99, 0.3); color: white; border-color: #9ca3af;}
        #edit-toolbar { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: rgba(17, 24, 39, 0.9); border: 1px solid #374151; border-radius: 12px; padding: 8px; display: flex; align-items: center; gap: 8px; z-index: 1001; transition: bottom 0.3s ease-in-out; box-shadow: 0 -4px 15px rgba(0,0,0,0.3); user-select: none; }
        #edit-toolbar.show { bottom: 20px; }
        #toolbar-title { cursor: move; padding: 4px 8px; color: #9ca3af; }
        .toolbar-btn { background-color: transparent; border: 1px solid #4b5563; color: #d1d5db; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; box-shadow: none; }
        .toolbar-btn:hover { background-color: rgba(75, 85, 99, 0.3); border-color: #9ca3af; }
        select, input[type="text"], textarea, input[type="range"] { background-color: #374151; border: 1px solid #4b5563; border-radius: 6px; color: #d1d5db; padding: 4px; }
        input[type="range"] { padding-left: 0; padding-right: 0; }
        input[type="color"] { padding: 2px; width: 40px; height: 30px; border: none; cursor: pointer; background-color: transparent; flex-shrink: 0; }
        .form-checkbox { appearance: none; background-color: #4b5563; border: 1px solid #6b7280; border-radius: 4px; width: 1.25em; height: 1.25em; position: relative; cursor: pointer; vertical-align: middle; }
        .form-checkbox:checked { background-color: #4f46e5; border-color: #4f46e5; }
        .form-checkbox:checked::after { content: '✓'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.9em; }
        .form-checkbox:disabled { cursor: not-allowed; background-color: #374151; opacity: 0.6; }

        /* --- 編輯模式網格 --- */
        #edit-mode-grid { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: linear-gradient(to bottom, transparent 24px, rgba(0, 255, 255, 0.2) 24px, rgba(0, 255, 255, 0.2) 25px, transparent 25px), linear-gradient(to right, transparent 24px, rgba(0, 255, 255, 0.2) 24px, rgba(0, 255, 255, 0.2) 25px, transparent 25px); background-size: 50px 50px; background-position: center center; z-index: 9; pointer-events: none; }
        #edit-mode-grid::before, #edit-mode-grid::after { content: ''; position: absolute; background-color: rgba(255, 0, 255, 0.5); z-index: 9; }
        #edit-mode-grid::before { top: 0; left: 50%; width: 1px; height: 100%; transform: translateX(-50%); }
        #edit-mode-grid::after { top: 50%; left: 0; width: 100%; height: 1px; transform: translateY(-50%); }
        body.edit-mode #edit-mode-grid { display: block; }
        /* --- 由 Tailwind 轉換的語意化 CSS --- */
        .display-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-space-between { justify-content: space-between; }
        .justify-content-center { justify-content: center; }
        .justify-content-flex-end { justify-content: flex-end; }
        .align-items-flex-start { align-items: flex-start; }
        .flex-direction-column { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-shrink-0 { flex-shrink: 0; }
        .flex-grow-1 { flex-grow: 1; }
        .display-grid { display: grid; }
        .grid-columns-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-columns-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-column-span-2 { grid-column: span 2 / span 2; }
        .grid-column-span-4 { grid-column: span 4 / span 4; } /* 新增 */

        .p0 { padding: 0; margin: 0; }
        .padding-1 { padding: 0.25rem; }
        .padding-2 { padding: 0.5rem; }
        .padding-1_5 { padding: 0.375rem; }
        .padding-3 { padding: 0.75rem; }
        .padding-5 { padding: 1.25rem; }
        .padding-6 { padding: 1.5rem; }
        .padding-top-1 { padding-top: 0.25rem; }
        .padding-bottom-1 { padding-bottom: 0.25rem; }
        .padding-bottom-2 { padding-bottom: 0.5rem; }
        .padding-bottom-4 { padding-bottom: 1rem; }
        .padding-right-2 { padding-right: 0.25rem; }
        .padding-horizontal-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .padding-horizontal-5 { padding-left: 1.25rem; padding-right: 1.25rem; }
        .padding-vertical-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .padding-vertical-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .margin-1 { margin: 0.25rem; }
        .margin-top-1 { margin-top: 0.25rem; }
        .margin-bottom-2 { margin-bottom: 0.5rem; }
        .margin-bottom-3 { margin-bottom: 0.75rem; }
        .margin-bottom-4 { margin-bottom: 1rem; }
        .margin-bottom-6 { margin-bottom: 1.5rem; }
        .margin-right-1 { margin-right: 0.25rem; }
        .margin-right-3 { margin-right: 0.75rem; }
        .margin-left-2 { margin-left: 0.5rem; }
        .margin-left-4 { margin-left: 1rem; }
        .margin-left-auto { margin-left: auto; }
        .margin-vertical-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .margin-top-2 { margin-top: 0.5rem; }
        .margin-top-3 { margin-top: 0.75rem; }
        .margin-top-4 { margin-top: 1rem; }
        .margin-top-6 { margin-top: 1.5rem; }

        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .column-gap-2 { column-gap: 0.5rem; }
        .column-gap-6 { column-gap: 1.5rem; }
        .column-gap-8 { column-gap: 2rem; }
        .row-gap-3 { row-gap: 0.75rem; }
        .row-gap-4 { row-gap: 1rem; }
        .row-gap-6 { row-gap: 1.5rem; }

        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; }
        .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; }
        .width-5 { width: 1.25rem; }
        .height-5 { height: 1.25rem; }
        .width-6 { width: 1.5rem; }
        .height-6 { height: 1.5rem; }
        .width-16 { width: 4rem; }
        .height-16 { height: 4rem; }
        .width-40 { width: 10rem; }
        .width-full { width: 100%; }
        .height-full { height: 100%; }
        .width-auto { width: auto; }
        .min-width-200px { min-width: 200px; }

        .max-width-sm { max-width: 24rem; }
        .max-width-md { max-width: 28rem; }
        .max-width-5xl { max-width: 64rem; }
        .max-height-80 { max-height: 20rem; }
        .max-height-90vh { max-height: 90vh; }

        .font-weight-bold { font-weight: 700; }
        .font-weight-semibold { font-weight: 600; }
        .font-size-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-size-md { font-size: 1rem; line-height: 1.5rem; }
        .font-size-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .font-size-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .font-size-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .line-height-none { line-height: 1; }
        .line-height-relaxed { line-height: 1.625; }
        .letter-spacing-wide { letter-spacing: 0.025em; }
        .text-align-center { text-align: center; }

        .color-white { color: #ffffff; }
        .color-gray-300 { color: #d1d5db; }
        .color-gray-400 { color: #9ca3af; }
        .color-indigo-300 { color: #a5b4fc; }

        .bg-transparent { background-color: transparent; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-indigo-600 { background-color: #4f46e5; }
        .border-1px { border-width: 1px; }
        .border-top-1px { border-top-width: 1px; }
        .border-bottom-1px { border-bottom-width: 1px; }
        .border-color-gray-600 { border-color: #4b5563; }
        .border-color-gray-700 { border-color: #374151; padding: 0; margin: 0; }

        .border-radius-sm { border-radius: 0.25rem; }
        .border-radius-lg { border-radius: 0.5rem; }
        .border-radius-full { border-radius: 9999px; }

        .cursor-pointer { cursor: pointer; }
        .cursor-help { cursor: help; }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover-bg-gray-600:hover { background-color: #4b5563; }
        .hover-bg-gray-700:hover { background-color: rgba(75, 85, 99, 0.3) !important; }
        .hover-color-white:hover { color: #ffffff; }
        .hover-color-indigo-300:hover { color: #a5b4fc; }
        .hover-bg-indigo-700:hover { background-color: #4338ca; }

        .display-none { display: none !important; }
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .position-relative { position: relative; }
        #calendar-container button, #moon-phase-container button,
        .action-button, .toolbar-btn, [data-close-modal],
        #useCurrentLocationBtn, #marquee-params-btn, #default-settings-btn, #random-colors-btn,
        #picker-prev-year, #picker-next-year, #prompt-cancel-btn, #prompt-ok-btn {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: #d1d5db; /* Default light color for text & icons */
            transition: color 0.2s, background-color 0.2s;
        }

        #calendar-container button:hover, #moon-phase-container button:hover,
        .toolbar-btn:hover, [data-close-modal]:hover,
        #useCurrentLocationBtn:hover, #marquee-params-btn:hover, #default-settings-btn:hover, 
        #random-colors-btn:hover, #picker-prev-year:hover, #picker-next-year:hover,
        #prompt-cancel-btn:hover, #prompt-ok-btn:hover, .action-button:hover {
            color: #ffffff !important;
        }

        /* Add a subtle visual feedback for circular/rounded buttons on hover */
        .action-button:hover, #useCurrentLocationBtn:hover, #marquee-params-btn:hover,
        #picker-prev-year:hover, #picker-next-year:hover, #prev-month:hover, 
        #next-month:hover, #moon-phase-prev-month:hover, #moon-phase-next-month:hover {
            background-color: rgba(75, 85, 99, 0.3) !important;
        }

        /* Ensure icon-only buttons are centered and properly sized */
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0; 
            margin: 0;
        }

        @media (min-width: 768px) {
            .md-grid-columns-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md-grid-columns-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .md-grid-column-span-2 { grid-column: span 2 / span 2; } /* 新增 */
            .md-grid-column-span-12 { grid-column: span 12 / span 12; }
        }
        @media (min-width: 1024px) {
            .lg-grid-columns-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .lg-grid-columns-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        }

    </style>
</head>
<body class="antialiased">
    <!-- SVG 圖示定義區 -->
    <svg style="display: none;">
        <defs>
            <!-- 移動圖示 -->
            <symbol id="icon-move" viewBox="0 0 24 24">
                <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"></path>
            </symbol>
            <!-- 其他可以整合的圖示也可以放在這裡 -->
        </defs>
    </svg>

    <div id="edit-mode-grid"></div>

    <div id="calendar-container" class="widget-container">
        <div class="widget-content-wrapper">
            <div id="background-month" class="background-month"></div>
            <header class="calendar-header">
                <h1 id="year-header" class="calendar-title" title="點擊快速選擇年月"></h1>
                <div class="calendar-nav">
                    <button id="prev-month" class="calendar-nav-arrow">
                        <svg class="height-6 width-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <button id="back-to-today" class="calendar-nav-today">今天</button>
                    <button id="next-month" class="calendar-nav-arrow">
                        <svg class="height-6 width-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </header>
            <main class="padding-bottom-2" style="position: relative; z-index: 2;">
                <div class="calendar-grid">
                    <div class="day-header">日</div><div class="day-header">一</div><div class="day-header">二</div><div class="day-header">三</div><div class="day-header">四</div><div class="day-header">五</div><div class="day-header">六</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>
            </main>
        </div>
        <div class="move-handle control-handle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg>
        </div>
        <div class="resize-handle-w control-handle"></div>
        <div class="resize-handle-h control-handle"></div>
    </div>
    <div id="led-clock-container" class="widget-container">
        <div class="widget-content-wrapper">
            <main>
                <svg id="led-clock-svg" viewBox="0 0 1200 350"></svg>
            </main>
        </div>
        <div class="move-handle control-handle">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg>
        </div>
        <div class="resize-handle-w control-handle"></div>
        <div class="resize-handle-h control-handle"></div>
    </div>

    <div id="analog-clock-container" class="widget-container">
        <div class="widget-content-wrapper">
            <main class="analog-clock-face">
                <div class="ticks-container" id="ticks-container"></div>
                <div class="analog-hand hour-hand"></div>
                <div class="analog-hand minute-hand"></div>
                <div class="analog-hand second-hand"></div>
                <div class="analog-pivot"></div>
            </main>
        </div>
        <div class="move-handle control-handle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg>
        </div>
    </div>
    <div id="marquee-container-0" class="widget-container marquee-widget">
        <div class="marquee-edit-indicator">1</div>
        <div class="widget-content-wrapper"><main><div class="marquee-inner"></div></main></div>
        <div class="move-handle control-handle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg></div>
        <div class="resize-handle-w control-handle"></div><div class="resize-handle-h control-handle"></div>
    </div>
    <div id="marquee-container-1" class="widget-container marquee-widget" style="display: none;">
        <div class="marquee-edit-indicator">2</div>
        <div class="widget-content-wrapper"><main><div class="marquee-inner"></div></main></div>
        <div class="move-handle control-handle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg></div>
        <div class="resize-handle-w control-handle"></div><div class="resize-handle-h control-handle"></div>
    </div>
    <div id="marquee-container-2" class="widget-container marquee-widget" style="display: none;">
        <div class="marquee-edit-indicator">3</div>
        <div class="widget-content-wrapper"><main><div class="marquee-inner"></div></main></div>
        <div class="move-handle control-handle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg></div>
        <div class="resize-handle-w control-handle"></div><div class="resize-handle-h control-handle"></div>
    </div>
    <div id="marquee-container-3" class="widget-container marquee-widget" style="display: none;">
        <div class="marquee-edit-indicator">4</div>
        <div class="widget-content-wrapper"><main><div class="marquee-inner"></div></main></div>
        <div class="move-handle control-handle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg></div>
        <div class="resize-handle-w control-handle"></div><div class="resize-handle-h control-handle"></div>
    </div>
    <div id="marquee-container-4" class="widget-container marquee-widget" style="display: none;">
        <div class="marquee-edit-indicator">5</div>
        <div class="widget-content-wrapper"><main><div class="marquee-inner"></div></main></div>
        <div class="move-handle control-handle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg></div>
        <div class="resize-handle-w control-handle"></div><div class="resize-handle-h control-handle"></div>
    </div>
    <div id="marquee-container-5" class="widget-container marquee-widget" style="display: none;">
        <div class="marquee-edit-indicator">6</div>
        <div class="widget-content-wrapper"><main><div class="marquee-inner"></div></main></div>
        <div class="move-handle control-handle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg></div>
        <div class="resize-handle-w control-handle"></div><div class="resize-handle-h control-handle"></div>
    </div>

    <div id="moon-phase-container" class="widget-container">
        <div class="widget-content-wrapper">
            <div id="moon-background-month" class="background-month"></div>
            <header class="calendar-header">
                <h1 id="moon-phase-year-header" class="calendar-title" title="點擊快速選擇年月"></h1>
                <div class="calendar-nav">
                    <button id="moon-phase-prev-month" class="calendar-nav-arrow"><svg class="height-6 width-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                    <button id="moon-phase-today" class="calendar-nav-today">今天</button>
                    <button id="moon-phase-next-month" class="calendar-nav-arrow"><svg class="height-6 width-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                </div>
            </header>
            <main class="padding-bottom-2" style="position: relative; z-index: 2;">
                <div class="calendar-grid">
                    <div class="day-header">日</div><div class="day-header">一</div><div class="day-header">二</div><div class="day-header">三</div><div class="day-header">四</div><div class="day-header">五</div><div class="day-header">六</div>
                </div>
                <div id="moon-calendar-body" class="calendar-grid"></div>
            </main>
        </div>
        <div class="move-handle control-handle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="width-full height-full"><use href="#icon-move"></use></svg>
        </div>
        <div class="resize-handle-w control-handle"></div>
        <div class="resize-handle-h control-handle"></div>
    </div>

    <div id="action-buttons" class="action-buttons">
        <button id="edit-layout-btn" class="action-button" title="編輯版面">
            <svg id="edit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            <svg id="edit-exit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="display-none"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <button id="settings-btn" class="action-button" title="設定">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
        <button id="fullscreen-btn" class="action-button" title="全螢幕">
            <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
            <svg id="fullscreen-exit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="display-none"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
        </button>
    </div>

    <div id="edit-toolbar">
        <span id="toolbar-title" title="按住拖曳">☰</span>
        <select id="layout-selector"></select>
        <button id="save-layout-btn" class="toolbar-btn">儲存</button>
        <button id="load-layout-btn" class="toolbar-btn">載入</button>
        <button id="export-layout-btn" class="toolbar-btn">導出</button>
        <button id="import-layout-btn" class="toolbar-btn">導入</button>
    </div>

    <div id="modal-backdrop-day" class="modal-backdrop"><div class="modal-content max-width-md"><div class="padding-6"><div class="display-flex justify-content-space-between align-items-flex-start margin-bottom-4"><div><h2 id="modal-gregorian-date" class="font-size-xl font-weight-bold color-white"></h2><p id="modal-lunar-date" class="font-size-md color-indigo-300"></p><p id="modal-holiday" class="font-size-md holiday-text margin-top-1 cursor-help"></p><p id="modal-solarterm" class="font-size-md solarterm-text cursor-help"></p></div><button data-close-modal="modal-backdrop-day" class="color-gray-400 hover-color-white font-size-3xl line-height-none">&times;</button></div><div class="margin-bottom-4 padding-3 bg-gray-800 border-radius-lg space-y-2 text-align-center"><p id="countdown-holiday-text" class="font-size-sm color-gray-300"></p><p id="countdown-solarterm-text" class="font-size-sm color-gray-300"></p></div>
<div id="modal-day-details-grid" class="margin-top-4 display-grid grid-columns-2 gap-4 text-align-center">
    <div>
        <p class="font-size-sm color-gray-400">日出</p>
        <p id="modal-sunrise-time" class="font-size-lg font-weight-semibold color-white"></p>
    </div>
    <div>
        <p class="font-size-sm color-gray-400">日落</p>
        <p id="modal-sunset-time" class="font-size-lg font-weight-semibold color-white"></p>
    </div>
    <div class="grid-column-span-2 display-flex align-items-center justify-content-center gap-4 padding-top-4 margin-top-2 border-top-1px border-color-gray-700">
         <div id="modal-moon-icon" class="width-16 height-16"></div>
         <div>
            <p class="font-size-sm color-gray-400">當日月相</p>
            <p id="modal-moon-phase-name" class="font-size-lg font-weight-semibold color-white"></p>
         </div>
    </div>
</div>
</div></div></div>
    <div id="modal-backdrop-picker" class="modal-backdrop"><div id="month-year-picker" class="modal-content"><div class="padding-5"><div class="year-nav margin-bottom-4"><button id="picker-prev-year" class="calendar-nav-arrow">&lt;</button><span id="picker-year" class="font-size-xl font-weight-bold">2024</span><button id="picker-next-year" class="calendar-nav-arrow">&gt;</button></div><div id="picker-month-grid" class="month-grid"></div></div></div></div>
    <div id="modal-backdrop-settings" class="modal-backdrop">
        <div class="modal-content max-width-5xl max-height-90vh display-flex flex-direction-column">
            <div class="padding-horizontal-5 padding-vertical-2 bg-gray-800" style="position: sticky; top: 0; z-index: 1;">
                <div class="display-flex justify-content-space-between align-items-center">
                    <h3 class="font-size-xl font-weight-bold color-indigo-300 p0">設定</h3>
                    <div class="display-flex align-items-center gap-3">
                        <button id="default-settings-btn" class="toolbar-btn font-size-sm padding-horizontal-3 padding-vertical-1">恢復預設</button>
                        <button id="random-colors-btn" class="toolbar-btn font-size-sm padding-horizontal-3 padding-vertical-1">隨機顏色</button>
                        <button data-close-modal="modal-backdrop-settings" class="color-gray-400 hover-color-white font-size-3xl line-height-none">&times;</button>
                    </div>
                </div>
            </div>
            <div class="overflow-y-auto padding-5">
                <div class="p0">
                     <div class="display-grid grid-columns-1 md-grid-columns-2 lg-grid-columns-4 column-gap-8 row-gap-6">
                        <div>
                            <h4 class="font-size-lg font-weight-semibold color-gray-400 margin-bottom-2 border-bottom-1px border-color-gray-600 padding-bottom-2">
                                <input type="checkbox" data-widget-toggle="calendar-container" class="form-checkbox">
                                <span>月曆</span>
                            </h4>
                            <div class="space-y-3">
                                <div class="display-flex justify-content-space-between align-items-center"><label>背景</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--bg-primary"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>年</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--year-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>月</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--month-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>日</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--day-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>星期</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--week-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>農曆</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--lunar-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>節日</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--holiday-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>節氣</label><input type="color" class="color-picker" data-setting-type="color" data-widget="calendar" data-var="--solarterm-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center">
                                    <label for="calendar-show-moon-icon-toggle" class="cursor-pointer">顯示月相</label>
                                    <input type="checkbox" id="calendar-show-moon-icon-toggle" class="form-checkbox" data-setting-type="toggle" data-widget="calendar" data-key="showMoonIcon">
                                </div>
                                <div class="display-flex justify-content-space-between align-items-center">
                                    <label for="calendar-use-led-font-toggle" class="cursor-pointer">使用 LED 字型</label>
                                    <input type="checkbox" id="calendar-use-led-font-toggle" class="form-checkbox" data-setting-type="toggle" data-widget="calendar" data-key="useLedFont">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-size-lg font-weight-semibold color-gray-400 margin-bottom-2 border-bottom-1px border-color-gray-600 padding-bottom-2">
                                <input type="checkbox" data-widget-toggle="moon-phase-container" class="form-checkbox">
                                <span>月相月曆</span>
                            </h4>
                            <div class="space-y-3">
                                <div class="display-flex justify-content-space-between align-items-center"><label>亮部</label><input type="color" class="color-picker" data-setting-type="color" data-widget="moonPhase" data-var="--moon-light-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>暗部</label><input type="color" class="color-picker" data-setting-type="color" data-widget="moonPhase" data-var="--moon-dark-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>標題</label><input type="color" class="color-picker" data-setting-type="color" data-widget="moonPhase" data-var="--moon-header-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>描述</label><input type="color" class="color-picker" data-setting-type="color" data-widget="moonPhase" data-var="--moon-desc-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>高亮</label><input type="color" class="color-picker" data-setting-type="color" data-widget="moonPhase" data-var="--moon-highlight-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center">
                                    <label for="moon-phase-use-led-font-toggle" class="cursor-pointer">使用 LED 字型</label>
                                    <input type="checkbox" id="moon-phase-use-led-font-toggle" class="form-checkbox" data-setting-type="toggle" data-widget="moonPhase" data-key="useLedFont">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-size-lg font-weight-semibold color-gray-400 margin-bottom-2 border-bottom-1px border-color-gray-600 padding-bottom-2">
                                <input type="checkbox" data-widget-toggle="led-clock-container" class="form-checkbox">
                                <span>LED 時鐘</span>
                            </h4>
                            <div class="space-y-3">
                                <div class="display-flex justify-content-space-between align-items-center"><label>時</label><input type="color" class="color-picker" data-setting-type="color" data-widget="ledClock" data-var="--led-hour-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>分</label><input type="color" class="color-picker" data-setting-type="color" data-widget="ledClock" data-var="--led-minute-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>秒</label><input type="color" class="color-picker" data-setting-type="color" data-widget="ledClock" data-var="--led-second-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>冒號</label><input type="color" class="color-picker" data-setting-type="color" data-widget="ledClock" data-var="--led-colon-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>時段</label><input type="color" class="color-picker" data-setting-type="color" data-widget="ledClock" data-var="--led-period-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center">
                                    <label for="led-clock-colon-blink-toggle" class="cursor-pointer">冒號閃爍</label>
                                    <input type="checkbox" id="led-clock-colon-blink-toggle" class="form-checkbox" data-setting-type="toggle" data-widget="ledClock" data-key="colonBlink">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-size-lg font-weight-semibold color-gray-400 margin-bottom-2 border-bottom-1px border-color-gray-600 padding-bottom-2">
                                <input type="checkbox" data-widget-toggle="analog-clock-container" class="form-checkbox">
                                <span>指針時鐘</span>
                            </h4>
                            <div class="space-y-3">
                                <div class="display-flex justify-content-space-between align-items-center"><label>指針</label><input type="color" class="color-picker" data-setting-type="color" data-widget="analogClock" data-var="--analog-hand-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>秒針</label><input type="color" class="color-picker" data-setting-type="color" data-widget="analogClock" data-var="--analog-second-hand-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>刻度</label><input type="color" class="color-picker" data-setting-type="color" data-widget="analogClock" data-var="--analog-tick-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center"><label>數字</label><input type="color" class="color-picker" data-setting-type="color" data-widget="analogClock" data-var="--analog-number-color"></div>
                                <div class="display-flex justify-content-space-between align-items-center">
                                    <label for="analog-clock-use-led-font-toggle" class="cursor-pointer">使用 LED 字型</label>
                                    <input type="checkbox" id="analog-clock-use-led-font-toggle" class="form-checkbox" data-setting-type="toggle" data-widget="analogClock" data-key="useLedFont">
                                </div>
                            </div>
                        </div>
                        <div class="grid-column-span-2 md-grid-column-span-4">
                            <div class="display-flex align-items-center justify-content-space-between width-full padding-vertical-2 border-top-1px border-color-gray-700 margin-top-4">
                                <div class="display-flex align-items-center gap-2">
                                    <input type="checkbox" id="timed-effect-enabled-toggle" class="form-checkbox">
                                    <label for="timed-effect-enabled-toggle" class="font-size-lg font-weight-semibold color-gray-400">定時特效</label>
                                </div>
                                <div class="display-flex align-items-center gap-2">
                                    <label>觸發間隔</label>
                                    <select id="timed-effect-interval-seconds"></select>
                                    <span>秒</span>
                                </div>
                            </div>
                        </div>
                     </div>
                </div>

                <div class="margin-top-6 padding-top-6 border-top-1px border-color-gray-700">
                    <div class="display-grid grid-columns-1 md-grid-columns-2 gap-4 align-items-center">
                        <div class="display-flex flex-direction-column row-gap-3 flex-shrink-0">
                            <div class="display-flex align-items-center column-gap-6 flex-wrap">
                                <div class="display-flex align-items-center gap-2">
                                    <input type="checkbox" id="marquee-enabled-toggle" class="form-checkbox" title="啟用/停用目前選擇的跑馬燈">
                                    <label for="marquee-enabled-toggle" class="font-size-lg font-weight-semibold color-gray-400 cursor-pointer">跑馬燈</label>
                                </div>
                                <div class="display-flex align-items-center">
                                    <label for="marquee-selector" class="flex-shrink-0">組別:</label>
                                    <select id="marquee-selector" class="width-auto bg-gray-700 border-1px border-color-gray-600 border-radius-sm margin-left-2"></select>
                                </div>
                                <div class="display-flex align-items-center column-gap-2 flex-grow-1 min-width-200px">
                                    <label for="marquee-speed-input" class="flex-shrink-0">速度</label>
                                    <input type="range" id="marquee-speed-input" min="1" max="1000" class="width-full">
                                </div>
                                <div class="display-flex align-items-center column-gap-4">
                                    <label class="display-flex align-items-center space-x-2 cursor-pointer flex-shrink-0"><input type="checkbox" id="marquee-vertical-toggle" class="form-checkbox"><span>直向</span></label>
                                    <div class="display-flex align-items-center">
                                        <label for="marquee-direction-select" class="flex-shrink-0 margin-right-2">方向:</label>
                                        <select id="marquee-direction-select"></select>
                                    </div>
                                    <div class="display-flex align-items-center column-gap-2">
                                        <label for="marquee-default-color">顏色</label>
                                        <input type="color" id="marquee-default-color" class="color-picker">
                                    </div>
                                     <div class="display-flex align-items-center gap-2">
                                        <input type="checkbox" id="marquee-use-led-font-toggle" class="form-checkbox" data-setting-type="toggle" data-widget="marqueeGlobal" data-key="useLedFont">
                                        <label for="marquee-use-led-font-toggle" class="cursor-pointer">LED 字型</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="display-flex align-items-center justify-content-flex-end gap-2 flex-wrap">
                            <label class="flex-shrink-0 margin-right-1">地區</label>
                            <select id="countySelect"></select>
                            <select id="districtSelect"></select>
                            <input id="manualLocationInput" type="text" placeholder="手動輸入英文地名" class="width-40">
                            <button id="useCurrentLocationBtn" class="padding-1_5 border-radius-full transition-colors flex-shrink-0" title="使用目前位置">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L12 6"/><path d="M12 18L12 22"/><path d="M20 12L22 12"/><path d="M2 12L4 12"/><circle cx="12" cy="12" r="2"/><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="margin-top-4 grid-column-span-2 display-flex align-items-flex-start">
                       <label for="marquee-text-input" class="flex-shrink-0 margin-right-3 padding-top-1">內容</label>
                       <div class="display-flex align-items-flex-start width-full">
                           <textarea id="marquee-text-input" class="width-full bg-gray-700 border-1px border-color-gray-600 border-radius-sm padding-horizontal-3 padding-vertical-2 color-white" rows="3"></textarea>
                           <button id="marquee-params-btn" class="margin-left-2 padding-1_5 border-radius-full transition-colors flex-shrink-0" title="顯示可用參數">
                               <svg xmlns="http://www.w3.org/2000/svg" class="height-5 width-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                           </button>
                       </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-backdrop-explanation" class="modal-backdrop"><div class="modal-content max-width-sm"><div class="padding-6"><div class="display-flex justify-content-space-between align-items-center margin-bottom-3"><h3 id="explanation-title" class="font-size-xl font-weight-bold color-indigo-300"></h3><button data-close-modal="modal-backdrop-explanation" class="color-gray-400 hover-color-white font-size-3xl line-height-none">&times;</button></div><p id="explanation-content" class="color-gray-300 line-height-relaxed"></p></div></div></div>
    <div id="modal-backdrop-prompt" class="modal-backdrop"><div class="modal-content max-width-sm"><div class="padding-6"><h3 id="prompt-title" class="font-size-xl font-weight-bold color-indigo-300 margin-bottom-4"></h3><p id="prompt-message" class="color-gray-300 margin-bottom-4"></p><input id="prompt-input" type="text" class="width-full bg-gray-700 border-1px border-color-gray-600 border-radius-sm padding-horizontal-3 padding-vertical-2 color-white margin-bottom-4"><div class="display-flex justify-content-flex-end gap-2"><button id="prompt-cancel-btn" class="toolbar-btn">取消</button><button id="prompt-ok-btn" class="toolbar-btn">確定</button></div></div></div></div>
    <div id="modal-backdrop-marquee-params" class="modal-backdrop">
        <div class="modal-content max-width-md">
            <div class="padding-6">
                <div class="display-flex justify-content-space-between align-items-center">
                    <h3 class="font-size-xl font-weight-bold color-indigo-300 p0">跑馬燈可用參數列表</h3>
                    <button data-close-modal="modal-backdrop-marquee-params" class="color-gray-400 hover-color-white font-size-3xl line-height-none">&times;</button>
                </div>
                <ul class="param-list max-height-80 overflow-y-auto padding-right-2">
                    <li class="param-group-title">特殊功能</li>
                    <li class="param-item"><strong>%C(#RRGGBB, 文字)%</strong>: 自訂文字顏色。例如: %C(#FFD700, 黃色文字)%</li>
                    <li class="param-item"><strong>%br%</strong>: (僅直向)手動換行</li>
                    <li class="param-item"><strong>提示:</strong> %C(...)% 參數中的文字部分不能再包含其他參數。系統會自動為時間、天氣等參數套用主題色彩。</li>

                    <li class="param-group-title">西元日期與時間</li>
                    <li class="param-item"><strong>%YYYY%</strong>: 四位數西元年 (例如: 2024)</li>
                    <li class="param-item"><strong>%YY%</strong>: 兩位數西元年 (例如: 24)</li>
                    <li class="param-item"><strong>%ROC_YY%</strong>: 民國年 (例如: 113)</li>
                    <li class="param-item"><strong>%MM%</strong>: 兩位數月份 (例如: 09)</li>
                    <li class="param-item"><strong>%M%</strong>: 月份，無前導零 (例如: 9)</li>
                    <li class="param-item"><strong>%DD%</strong>: 兩位數日期 (例如: 08)</li>
                    <li class="param-item"><strong>%D%</strong>: 日期，無前導零 (例如: 8)</li>
                    <li class="param-item"><strong>%WEEKDAY%</strong>: 星期全名 (例如: 星期日)</li>
                    <li class="param-item"><strong>%W_SHORT%</strong>: 星期簡稱 (例如: 週日)</li>
                    <li class="param-item"><strong>%W_CHAR%</strong>: 星期單字 (例如: 日)</li>
                    <li class="param-item"><strong>%W_NUM%</strong>: 星期數字 (0 為星期日)</li>
                    <li class="param-item"><strong>%HH%</strong>: 24小時制，兩位數 (例如: 23)</li>
                    <li class="param-item"><strong>%H%</strong>: 24小時制，無前導零 (例如: 23)</li>
                    <li class="param-item"><strong>%hh%</strong>: 12小時制，兩位數 (例如: 11)</li>
                    <li class="param-item"><strong>%h%</strong>: 12小時制，無前導零 (例如: 11)</li>
                    <li class="param-item"><strong>%mm%</strong>: 分鐘，兩位數 (例如: 05)</li>
                    <li class="param-item"><strong>%m%</strong>: 分鐘，無前導零 (例如: 5)</li>
                    <li class="param-item"><strong>%ss%</strong>: 秒數，兩位數 (例如: 01)</li>
                    <li class="param-item"><strong>%s%</strong>: 秒數，無前導零 (例如: 1)</li>
                    <li class="param-item"><strong>%ap_c%</strong>: 中文時段 (例如: 上午, 下午)</li>
                    <li class="param-item"><strong>%AP%</strong>: 英文時段，大寫 (AM/PM)</li>
                    <li class="param-item"><strong>%ap%</strong>: 英文時段，小寫 (am/pm)</li>
                    <li class="param-group-title">農曆與生肖</li>
                    <li class="param-item"><strong>%L_GZ%</strong>: 農曆年干支 (例如: 甲辰)</li>
                    <li class="param-item"><strong>%L_SX%</strong>: 生肖 (例如: 龍)</li>
                    <li class="param-item"><strong>%LM_C%</strong>: 農曆中文月份 (例如: 八月)</li>
                    <li class="param-item"><strong>%LD_C%</strong>: 農曆中文日期 (例如: 初三)</li>
                    <li class="param-group-title">時辰</li>
                    <li class="param-item"><strong>%SHICHEN_GZ%</strong>: 時辰干支 (例如: 甲子)</li>
                    <li class="param-item"><strong>%SHICHEN_NAME%</strong>: 時辰全名 (例如: 子時)</li>
                    <li class="param-item"><strong>%SHICHEN_CHAR%</strong>: 時辰地支 (例如: 子)</li>

                    <li class="param-group-title">月相</li>
                    <li class="param-item"><strong>%MOON_PHASE%</strong>: 當日月相名稱 (例: 望月(滿月))</li>
                    <li class="param-item"><strong>%MOON_ICON%</strong>: 當日月相圖示 (SVG圖示)</li>
                    <li class="param-item"><strong>%MOON_DAY%</strong>: 農曆日期 (數字, 1-30)</li>

                    <li class="param-group-title">天氣資訊</li>
                    <li class="param-item"><strong>%WEATHER_LOC%</strong>: 地點</li>
                    <li class="param-item"><strong>%WEATHER_DESC%</strong>: 天氣描述 (例如: 晴)</li>
                    <li class="param-item"><strong>%TEMP%</strong>: 氣溫(°C)</li>
                    <li class="param-item"><strong>%SUNRISE%</strong>: 日出時間 (HH:mm)</li>
                    <li class="param-item"><strong>%SUNSET%</strong>: 日落時間 (HH:mm)</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // --- 全域變數，用於控制天氣載入狀態 ---
        let weatherDataLoaded = false;

        document.addEventListener('DOMContentLoaded', function () {
            // --- 農曆轉換核心演算法 ---
            function getLunarYearDays(y){let i,sum=348;for(i=0x8000;i>0x8;i>>=1)sum+=(lunarInfo[y-1900]&i)?1:0;return sum+getLunarLeapDays(y)}
            function getLunarLeapMonth(y){return lunarInfo[y-1900]&0xf}
            function getLunarLeapDays(y){return getLunarLeapMonth(y)?((lunarInfo[y-1900]&0x10000)?30:29):0}
            function getLunarMonthDays(y,m){return(lunarInfo[y-1900]&(0x10000>>m))?30:29}
            function toChinaDate(d) {
                if (d < 1 || d > 30) return "";
                const n1 = "一二三四五六七八九";
                if (d <= 10) {
                    return "初" + (d === 10 ? "十" : n1[d-1]);
                } else if (d < 20) {
                    return "十" + n1[(d % 10) - 1];
                } else if (d === 20) {
                    return "二十";
                } else if (d < 30) {
                    return "廿" + n1[(d % 10) - 1];
                } else { // d === 30
                    return "三十";
                }
            }
            let lunarDateCache={};
            function getLunarDate(date){
                const cleanDate = new Date(date);
                cleanDate.setHours(0, 0, 0, 0);
                const key=cleanDate.toISOString().split('T')[0];
                if(lunarDateCache[key])return lunarDateCache[key];
                let i,temp=0;const baseDate=new Date(1900,0,31);
                let offset=(cleanDate-baseDate)/86400000;
                for(i=1900;i<2101&&offset>0;i++){temp=getLunarYearDays(i);offset-=temp}if(offset<0){offset+=temp;i--}const year=i;const leapMonth=getLunarLeapMonth(year);let isLeap=false;for(i=1;i<13&&offset>0;i++){temp=getLunarMonthDays(year,i);offset-=temp;if(offset<0){break}if(leapMonth>0&&i===leapMonth){temp=getLunarLeapDays(year);offset-=temp;if(offset<0){isLeap=true;break}}}if(offset<0){offset+=temp}const month=i;
                const day=Math.round(offset)+1;
                const monthStr=(isLeap?'閏':'')+"正二三四五六七八九十冬臘"[month-1]+'月';
                const result={year:year,month:month,day:day,isLeap:isLeap,toString:monthStr+toChinaDate(day),dayString:toChinaDate(day)};
                lunarDateCache[key]=result;return result
            }
            function lunarToSolar(lunarYear,lunarMonth,lunarDay,isLeap=false){if(lunarYear<1900||lunarYear>2100)return null;const leap=getLunarLeapMonth(lunarYear);if(isLeap&&leap!==lunarMonth)return null;let daysOffset=0;for(let y=1900;y<lunarYear;y++){daysOffset+=getLunarYearDays(y)}for(let m=1;m<lunarMonth;m++){daysOffset+=getLunarMonthDays(lunarYear,m);if(leap>0&&m===leap){daysOffset+=getLunarLeapDays(lunarYear)}}if(isLeap){daysOffset+=getLunarMonthDays(lunarYear,lunarMonth)}daysOffset+=lunarDay-1;const baseDate=new Date(1900,0,31);return new Date(baseDate.getTime()+daysOffset*86400000)}
            let solarTermsCache={};
            function calculateAndCacheSolarTerms(year){if(year<2000||year>2099){solarTermsCache[year]={};return}const yearMap={};const Y=year-2000;solarTermConstants.forEach(([name,month,C])=>{const day=Math.floor(Y*0.2422+C)-Math.floor(Y/4);yearMap[`${year}-${month}-${day}`]=name});solarTermsCache[year]=yearMap}
            function getSolarTerm(year,month,day){if(!solarTermsCache[year]){calculateAndCacheSolarTerms(year)}return solarTermsCache[year][`${year}-${month}-${day}`]||null}
            function getHoliday(date) {
                const month = date.getMonth() + 1;
                const dayOfMonth = date.getDate();
                const dayOfWeek = date.getDay(); // 0=Sunday

                // 1. Check Gregorian (fixed date) holidays
                const gKey = `${month}-${dayOfMonth}`;
                if (gregorianHolidays[gKey]) return gregorianHolidays[gKey];

                // 2. Check floating holidays (e.g., 2nd Sunday of May)
                const weekOfMonth = Math.ceil(dayOfMonth / 7);
                const fKey = `${month}-${weekOfMonth}-${dayOfWeek}`;
                if (floatingHolidays[fKey]) return floatingHolidays[fKey];

                // 3. Check Lunar holidays
                const l = getLunarDate(date);
                if (l.day > 0) {
                    // Special, more robust check for Lunar New Year's Eve
                    if (l.month === 12 && l.day === getLunarMonthDays(l.year, 12)) {
                        return "除夕";
                    }
                    const lKey = `${l.month}-${l.day}`;
                    if (lunarHolidays[lKey]) return lunarHolidays[lKey];
                }

                return null;
            }
            const yiJiMap={};
            function getYiJiForDate(year,month,day){const key=`${year}-${month}-${day}`;if(yiJiMap[key])return yiJiMap[key];const allGood=["嫁娶","祈福","求嗣","出行","入宅","開市","安床","祭祀","納采","修造"];const allBad=["動土","安葬","作灶","伐木","行喪","破土","詞訟","赴任"];const seed=year*10000+month*100+day;const randomGood=[...allGood].sort(()=>0.5-(seed%1000/1000)).slice(0,5);const randomBad=[...allBad].sort(()=>0.5-(seed%888/888)).slice(0,3);return{good:randomGood,bad:randomBad}}
            // --- 時辰計算輔助 ---
            function getDailyGanzhi(date) {
                const cleanDate = new Date(date);
                cleanDate.setHours(0, 0, 0, 0);
                // 基準日: 1900年1月31日是庚辰日。庚(6), 辰(4)。
                const baseDate = new Date(1900, 0, 31);
                const offset = Math.floor((cleanDate - baseDate) / 86400000);
                const positiveOffset = offset + 60000; // 確保正數
                const dayStemIndex = (6 + positiveOffset) % 10;
                return { stemIndex: dayStemIndex };
            }
            const ShichenHelper = {
                // 根據日干查詢時辰的起始天干 (甲己日起甲子時, 乙庚日起丙子時...)
                hourStemStart: [0, 2, 4, 6, 8, 0, 2, 4, 6, 8], 
                getData(date) {
                    const h = date.getHours();
                    // 子時(23-01)的地支序數為0
                    const branchIndex = Math.floor(((h + 1) % 24) / 2);
                    const branchChar = dizhi[branchIndex];
                    const dailyGanzhi = getDailyGanzhi(date);
                    const dayStemIndex = dailyGanzhi.stemIndex;
                    const hourStemIndex = (this.hourStemStart[dayStemIndex] + branchIndex) % 10;
                    const hourStemChar = tiangan[hourStemIndex];

                    return {
                        name: `${branchChar}時`,
                        char: branchChar,
                        gz: `${hourStemChar}${branchChar}`
                    };
                }
            };

            const TimeHelper = {
                timeRanges: [{h:23,p:'深夜'},{h:19,p:'夜晚'},{h:17,p:'傍晚'},{h:13,p:'下午'},{h:12,p:'中午'},{h:9,p:'上午'},{h:5,p:'清晨'},{h:0,p:'凌晨'}],
                getPeriodText(hour) { return this.timeRanges.find(range => hour >= range.h)?.p || ''; },
            };

            // --- 全局 DOM 元素 ---
            const allWidgetContainers = () => document.querySelectorAll('.widget-container');
            const actionButtons = document.getElementById('action-buttons');
            const editToolbar = document.getElementById('edit-toolbar');
            // --- 狀態變數 ---
            let isEditMode = false;
            let activityTimeout;
            let transformStates = {};
            let settingsState = {};
            let isWidgetAnimating = {};

            // --- 跑馬燈參數與顏色變數的映射表 ---
            const marqueeParamColorMap = {
                '%YYYY%': '--year-color', '%ROC_YY%': '--year-color', '%MM%': '--month-color', '%DD%': '--day-color',
                '%WEEKDAY%': '--week-color', '%W_SHORT%': '--week-color', '%HH%': '--led-hour-color', '%hh%': '--led-hour-color',
                '%mm%': '--led-minute-color', '%ss%': '--led-second-color', '%ap_c%': '--led-period-color', '%L_GZ%': '--lunar-color',
                '%L_SX%': '--lunar-color', '%LM_C%': '--lunar-color', '%LD_C%': '--lunar-color', '%WEATHER_LOC%': '--holiday-color',
                '%WEATHER_DESC%': '--holiday-color', '%TEMP%': '--holiday-color', '%SUNRISE%': '--solarterm-color',
                '%SUNSET%': '--solarterm-color', '%MOON_PHASE%': '--moon-header-color', '%MOON_ICON%': '--moon-header-color',
                '%MOON_DAY%': '--moon-header-color',
                '%SHICHEN_GZ%': '--lunar-color', '%SHICHEN_NAME%': '--lunar-color', '%SHICHEN_CHAR%': '--lunar-color'
            };

            // --- 預設設定 ---
            const userDefaultLayout = {
                "transforms": {
                    "calendar-container": { "visible": true, "width": 520, "height": 650, "left": 550, "top": 320, "scale": 1 },
                    "moon-phase-container": { "visible": false, "width": 520, "height": 650, "left": 10, "top": 320, "scale": 1 },
                    "led-clock-container": { "visible": true, "width": 700, "height": 320, "left": 10, "top": 10, "scale": 1 },
                    "analog-clock-container": { "visible": true, "width": 300, "height": 300, "left": 760, "top": 10, "scale": 1 },
                    "marquee-container-0": { "visible": true, "width": 1060, "height": 50, "left": 10, "top": 1000, "scale": 1 },
                    "marquee-container-1": { "visible": false, "width": 400, "height": 50, "left": 100, "top": 200, "scale": 1 },
                    "marquee-container-2": { "visible": false, "width": 400, "height": 50, "left": 100, "top": 260, "scale": 1 },
                    "marquee-container-3": { "visible": false, "width": 400, "height": 50, "left": 100, "top": 320, "scale": 1 },
                    "marquee-container-4": { "visible": false, "width": 400, "height": 50, "left": 100, "top": 380, "scale": 1 },
                    "marquee-container-5": { "visible": false, "width": 400, "height": 50, "left": 100, "top": 440, "scale": 1 }
                },
                "settings": {
                    "calendar": { "visible": true, "showMoonIcon": true, "useLedFont": true, "colors": { "--bg-primary": "#000000", "--year-color": "#FF3333", "--month-color": "#555555", "--week-color": "#cccccc", "--day-color": "#ffffff", "--lunar-color": "#9CA3AF", "--bg-secondary": "transparent", "--bg-hover": "rgba(55, 65, 81, 0.5)", "--border-color": "#374151", "--text-primary": "#F3F4F6", "--text-secondary": "#9CA3AF", "--text-muted": "#6B7280", "--today-bg": "transparent", "--today-border": "#6366f1", "--holiday-color": "#6ee7b7", "--solarterm-color": "#fcd34d", "--yi-color": "#34D399", "--ji-color": "#F87171" } },
                    "ledClock": { "visible": true, "colonBlink": true, "colors": { "--led-hour-color": "#00ff00", "--led-minute-color": "#00ff00", "--led-second-color": "#00ff00", "--led-colon-color": "#00ff00", "--led-period-color": "#00ff00" } },
                    "analogClock": { "visible": true, "useLedFont": true, "colors": { "--analog-face-color": "transparent", "--analog-hand-color": "#ffffff", "--analog-second-hand-color": "#ff3333", "--analog-tick-color": "#cccccc", "--analog-number-color": "#ffffff" } },
                    "moonPhase": { "visible": false, "useLedFont": true, "colors": { "--moon-light-color": "#f0e68c", "--moon-dark-color": "#222222", "--moon-header-color": "#a78bfa", "--moon-desc-color": "#d1d5db", "--moon-highlight-color": "#fcd34d" } },
                    "marquees": [
                        { "text": "%YYYY%/%ROC_YY%年%MM%月%DD%日%br%%W_SHORT%%ap_c%%hh%%C(#00FF00, :)%%mm%%br%%C(#FFFF00, 農曆)%%LM_C%%LD_C%%SHICHEN_NAME%%L_GZ%%L_SX%%L_GZ%%MOON_ICON%%br%%WEATHER_LOC%%WEATHER_DESC%%TEMP%°C%br%日出%SUNRISE%%br%日落%SUNSET%", "speed": 80, "vertical": false, "direction": "left", "colors": {"default":"#FFFFFF"} },
                        { "text": "", "speed": 80, "vertical": false, "direction": "left", "colors": {"default":"#FFFFFF"} }, { "text": "", "speed": 80, "vertical": false, "direction": "left", "colors": {"default":"#FFFFFF"} },
                        { "text": "", "speed": 80, "vertical": false, "direction": "left", "colors": {"default":"#FFFFFF"} }, { "text": "", "speed": 80, "vertical": false, "direction": "left", "colors": {"default":"#FFFFFF"} },
                        { "text": "", "speed": 80, "vertical": false, "direction": "left", "colors": {"default":"#FFFFFF"} }
                    ],
                    "marqueeGlobal": { "useLedFont": true },
                    "location": "taiwan",
                    "timedEffect": {
                        "enabled": true,
                        "intervalSeconds": 30
                    }
                }
            };
            // ===================================================================
            // LED 時鐘模組
            // ===================================================================
            const LedClock = {
                svg: document.getElementById('led-clock-svg'), digits: {}, colons: {}, periodTextElement: null,
                segmentMap: [[1,1,1,1,1,1,0],[0,1,1,0,0,0,0],[1,1,0,1,1,0,1],[1,1,1,1,0,0,1],[0,1,1,0,0,1,1],[1,0,1,1,0,1,1],[1,0,1,1,1,1,1],[1,1,1,0,0,0,0],[1,1,1,1,1,1,1],[1,1,1,1,0,1,1]],
                segmentTransforms: ['translate(0, 0)','translate(132, 20) rotate(90)','translate(132, 140) rotate(90)','translate(0, 240)','translate(12, 140) rotate(90)','translate(12, 20) rotate(90)','translate(0, 120)'],
                baseViewBoxWidth: 0, aspectRatio: 0,
                createDigit(id, x, parentGroup, segmentClass) { const group = document.createElementNS('http://www.w3.org/2000/svg', 'g'); group.setAttribute('id', id); group.setAttribute('transform', `translate(${x}, 0)`); for (let i = 0; i < 7; i++) { const use = document.createElementNS('http://www.w3.org/2000/svg', 'use'); use.setAttribute('href', '#segment-shape'); use.setAttribute('class', `segment ${segmentClass}`); use.setAttribute('data-segment', String.fromCharCode(97 + i)); use.setAttribute('transform', this.segmentTransforms[i]); group.appendChild(use); } parentGroup.appendChild(group); return group; },
                createColon(id, x, parentGroup) { const group = document.createElementNS('http://www.w3.org/2000/svg', 'g'); group.setAttribute('id', id); group.setAttribute('transform', `translate(${x}, 0)`); ['translate(0, 60)', 'translate(0, 180)'].forEach(transform => { const dot = document.createElementNS('http://www.w3.org/2000/svg', 'use'); dot.setAttribute('href', '#colon-dot-shape'); dot.setAttribute('class', 'colon'); dot.setAttribute('transform', transform); group.appendChild(dot); }); parentGroup.appendChild(group); return group; },
                init() { this.svg.innerHTML = ''; const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs'); defs.innerHTML = `<polygon id="segment-shape" points="16 0, 96 0, 112 16, 96 32, 16 32, 0 16" /><rect id="colon-dot-shape" x="-16" y="0" width="32" height="32" rx="5" ry="5" />`; this.svg.appendChild(defs); const digitWidth=160, colonWidth=48, digitSpacing=2, hourMinuteSpacing=0, secondsScale=0.25, minuteSecondSpacing=8; const viewportGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g'); this.svg.appendChild(viewportGroup); let currentX = 0; this.digits.h1 = this.createDigit('digit-h1', currentX, viewportGroup, 'segment-h'); currentX += digitWidth + digitSpacing; this.digits.h2 = this.createDigit('digit-h2', currentX, viewportGroup, 'segment-h'); currentX += digitWidth + hourMinuteSpacing; this.colons.h = this.createColon('colon-h', currentX, viewportGroup); currentX += colonWidth + hourMinuteSpacing; this.digits.m1 = this.createDigit('digit-m1', currentX, viewportGroup, 'segment-m'); currentX += digitWidth + digitSpacing; this.digits.m2 = this.createDigit('digit-m2', currentX, viewportGroup, 'segment-m'); const mainDigitsWidth = currentX + digitWidth; const secondsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g'); viewportGroup.appendChild(secondsGroup); this.digits.s1 = this.createDigit('digit-s1', 0, secondsGroup, 'segment-s'); this.digits.s2 = this.createDigit('digit-s2', digitWidth + digitSpacing, secondsGroup, 'segment-s'); this.periodTextElement = document.createElementNS('http://www.w3.org/2000/svg', 'text'); this.periodTextElement.setAttribute('class', 'period-text'); this.periodTextElement.setAttribute('dominant-baseline', 'hanging'); viewportGroup.appendChild(this.periodTextElement); const mainDigitHeight = 240 + 32; const scaledSecondsHeight = mainDigitHeight * secondsScale; const secondsGroupWidth = (digitWidth * 2 + digitSpacing) * secondsScale; const sideAreaWidth = Math.max(secondsGroupWidth, 110); const totalContentWidth = mainDigitsWidth + minuteSecondSpacing + sideAreaWidth; const totalContentHeight = mainDigitHeight; this.baseViewBoxWidth = totalContentWidth + 20; this.aspectRatio = this.baseViewBoxWidth / totalContentHeight; this.svg.setAttribute('viewBox', `0 0 ${this.baseViewBoxWidth} ${totalContentHeight}`); viewportGroup.setAttribute('transform', 'translate(20, 0)'); const secondsX = mainDigitsWidth + minuteSecondSpacing; const secondsY = totalContentHeight - scaledSecondsHeight; secondsGroup.setAttribute('transform', `translate(${secondsX}, ${secondsY}) scale(${secondsScale})`); 
                    const periodTextX = mainDigitsWidth + minuteSecondSpacing - 20; 
                    const periodTextY = 0; 
                    this.periodTextElement.setAttribute('x', periodTextX); 
                    this.periodTextElement.setAttribute('y', periodTextY); this.update(); setInterval(() => this.update(), 1000); 
                },
                updateDigit(digitElement, number) { const pattern = this.segmentMap[number]; digitElement.querySelectorAll('.segment').forEach((segment, i) => { segment.style.opacity = pattern[i] ? '1' : '0.1'; }); },
                update() {
                    const now = new Date(); let h = now.getHours(); const m = now.getMinutes(); const s = now.getSeconds();
                    // --- 定時特效觸發邏輯 ---
                    const effectSettings = settingsState.timedEffect;
                    // 2024-09-13: 檢查是否在編輯模式，如果是，則不觸發特效
                    if (!isEditMode && effectSettings && effectSettings.enabled && s > 0 && s % effectSettings.intervalSeconds === 0) {
                        // 避免重複觸發
                        if (Object.values(isWidgetAnimating).some(v => v)) return;

                        // 收集所有可見的非跑馬燈元件，以及可見且「未捲動」的跑馬燈元件
                        let targets = [];
                        const nonMarqueeTargets = ['calendar-container', 'moon-phase-container', 'led-clock-container', 'analog-clock-container'];

                        nonMarqueeTargets.forEach(id => {
                            const state = transformStates[id];
                            if (state && state.visible) {
                                targets.push(id);
                            }
                        });
                        MarqueeManager.instances.forEach(instance => {
                            const state = transformStates[instance.container.id];
                            // 只有當元件可見且內容未達捲動標準時，才加入特效目標
                            if (state && state.visible && !instance.isScrolling) {
                                targets.push(instance.container.id);
                            }
                        });

                        // 如果沒有目標，則不執行
                        if (targets.length === 0) return;

                        const directions = ['up', 'down', 'left', 'right'];
                        const move = {
                            up: 'translateY(-100vh)',
                            down: 'translateY(100vh)',
                            left: 'translateX(-100vw)',
                            right: 'translateX(100vw)'
                        };
                        const duration = 700;

                        targets.forEach(id => {
                            const el = document.getElementById(id);
                            // 再次確認 el 存在且沒有在動畫中
                            if (!el || isWidgetAnimating[id]) return;

                            // 為每個元件隨機選擇一個不同的方向
                            const direction = directions[Math.floor(Math.random() * directions.length)];

                            isWidgetAnimating[id] = true;

                            const originalTransform = el.style.transform;
                            const originalTransition = el.style.transition;

                            // 套用 transition 並移動
                            el.style.transition = `transform ${duration}ms ease-in-out`;
                            el.style.transform = `${originalTransform} ${move[direction]}`;

                            // 設定計時器以還原樣式
                            setTimeout(() => {
                                // 無 transition 狀態下還原
                                el.style.transition = 'none';
                                el.style.transform = originalTransform;

                                // 透過另一個短計時器恢復原始的 transition 屬性
                                setTimeout(() => {
                                    el.style.transition = originalTransition;
                                    isWidgetAnimating[id] = false;
                                }, 50);
                            }, duration);
                        });
                    }

                    if (this.periodTextElement) { this.periodTextElement.textContent = TimeHelper.getPeriodText(h); }
                    let h12 = h % 12; if (h12 === 0) h12 = 12; const hStr = String(h12).padStart(2, '0'); const mStr = String(m).padStart(2, '0'); const sStr = String(s).padStart(2, '0');
                    this.updateDigit(this.digits.h1, parseInt(hStr[0])); this.updateDigit(this.digits.h2, parseInt(hStr[1])); this.updateDigit(this.digits.m1, parseInt(mStr[0])); this.updateDigit(this.digits.m2, parseInt(mStr[1])); this.updateDigit(this.digits.s1, parseInt(sStr[0])); this.updateDigit(this.digits.s2, parseInt(sStr[1]));
                    
                    const shouldBlink = settingsState.ledClock?.colonBlink ?? true;
                    const colonOpacity = shouldBlink ? (s % 2 === 0 ? '1' : '0.2') : '1';
                    this.colons.h.querySelectorAll('.colon').forEach(c => c.style.opacity = colonOpacity);
                },
            };
            // ===================================================================
            // 月曆模組
            // ===================================================================
            const Calendar = { body: document.getElementById('calendar-body'), yearHeader: document.getElementById('year-header'), backgroundMonth: document.getElementById('background-month'), currentDate: new Date(), init() { this.render(); document.getElementById('prev-month').addEventListener('click', () => { if(!isEditMode) { this.currentDate.setMonth(this.currentDate.getMonth() - 1); this.render(); } }); document.getElementById('next-month').addEventListener('click', () => { if(!isEditMode) { this.currentDate.setMonth(this.currentDate.getMonth() + 1); this.render(); } }); document.getElementById('back-to-today').addEventListener('click', () => { if(!isEditMode) { this.currentDate = new Date(); this.render(); } }); }, render() { this.body.innerHTML = ''; const year = this.currentDate.getFullYear(); const month = this.currentDate.getMonth(); const useLedHeader = settingsState.calendar?.useLedFont ?? true; const yearColor = getComputedStyle(document.documentElement).getPropertyValue('--year-color').trim() || '#FF3333'; renderCalendarTitle(this.yearHeader, year, useLedHeader, 26, yearColor, '26px', yearColor); this.backgroundMonth.textContent = month + 1; const firstDayOfMonth = new Date(year, month, 1); const startDayOfWeek = firstDayOfMonth.getDay(); const startDate = new Date(year, month, 1 - startDayOfWeek); const today = new Date(); today.setHours(0,0,0,0); for (let i = 0; i < 42; i++) { const currentCellDate = new Date(startDate); currentCellDate.setDate(startDate.getDate() + i); const cell = document.createElement('div'); cell.className = 'calendar-day' + (isEditMode ? ' edit-mode-active' : '') + (currentCellDate.getMonth() !== month ? ' other-month' : '') + (currentCellDate.getTime() === today.getTime() ? ' today' : ''); const date = currentCellDate.getDate(); const lunar = getLunarDate(currentCellDate); const solarTerm = getSolarTerm(currentCellDate.getFullYear(), currentCellDate.getMonth() + 1, date); const holiday = getHoliday(currentCellDate);
                const showMoonIcon = settingsState.calendar?.showMoonIcon ?? true;
                const useLed = settingsState.calendar?.useLedFont ?? true;
                const textDetailsHTML = `
                    <div class="lunar-date">${lunar.day === 1 ? lunar.toString.substring(0, lunar.isLeap ? 3 : 2) : lunar.dayString}</div>
                    ${solarTerm ? `<div class="solarterm-text truncate" data-key="${solarTerm}">${solarTerm}</div>` : ''}
                    ${holiday ? `<div class="holiday-text truncate" data-key="${holiday}">${holiday}</div>` : ''}
                `;
                const dayColor = getComputedStyle(document.documentElement).getPropertyValue('--day-color').trim();
                const dayNumberHTML = useLed ? `<div class="day-number-wrapper">${generateLedSvg(String(date), {height: 20, color: dayColor})}</div>` : `<div class="day-number-wrapper" style="font-size: 1.5em; line-height: 1.2; color: ${dayColor}; display: flex; align-items: center; justify-content: center; height: 20px; font-weight: 700;">${date}</div>`;

                if (showMoonIcon) {
                    cell.classList.add('with-moon-icon');
                    cell.innerHTML = `
                        <div class="day-text-content">
                            ${dayNumberHTML}
                            <div class="space-y-px">${textDetailsHTML}</div>
                        </div>
                        <div class="day-moon-container">
                            ${MoonPhaseWidget.getMoonPhaseSVG(lunar.day, '28px', `main-cal-${i}`)}
                        </div>
                    `;
                } else {
                    cell.classList.remove('with-moon-icon');
                     cell.innerHTML = `
                        ${dayNumberHTML}
                        <div class="space-y-px">${textDetailsHTML}</div>
                    `;
                }
                cell.dataset.date = currentCellDate.toISOString(); this.body.appendChild(cell); } } };

            // ===================================================================
            // 指針時鐘模組
            // ===================================================================
            const AnalogClock = {
                hourHand: document.querySelector('#analog-clock-container .hour-hand'),
                minuteHand: document.querySelector('#analog-clock-container .minute-hand'),
                secondHand: document.querySelector('#analog-clock-container .second-hand'),
                ticksContainer: document.getElementById('ticks-container'),
                init() {
                    this.ticksContainer.innerHTML = '';
                    const useLed = settingsState.analogClock?.useLedFont ?? true;
                    for (let i = 1; i <= 60; i++) {
                        const isHour = i % 5 === 0;
                        const rotation = i * 6;
                        const wrapper = document.createElement('div');
                        wrapper.className = 'tick-wrapper';
                        wrapper.style.transform = `rotate(${rotation}deg)`;
                        const tick = document.createElement('div');
                        tick.className = isHour ? 'tick tick-hour' : 'tick tick-minute';
                        wrapper.appendChild(tick);
                        
                        if (isHour) {
                            wrapper.style.setProperty('--rotation', `${rotation}deg`);
                            const numDiv = document.createElement('div');
                            numDiv.className = 'number';
                            
                            const numberText = String(i / 5);
                            const numberColor = getComputedStyle(document.documentElement).getPropertyValue('--analog-number-color').trim() || '#ffffff';

                            if (useLed) {
                                const clockState = transformStates['analog-clock-container'];
                                const svgHeight = clockState ? clockState.width * 0.08 : 16;
                                numDiv.innerHTML = `<div>${generateLedSvg(numberText, { height: svgHeight, color: numberColor })}</div>`;
                            } else {
                                numDiv.innerHTML = `<div style="transform: rotate(calc(-1 * var(--rotation))); color: ${numberColor}; font-size: 1.2em; font-weight: bold;">${numberText}</div>`;
                            }
                            wrapper.appendChild(numDiv);
                        }
                        this.ticksContainer.appendChild(wrapper);
                    }
                    if (!this.animationFrameId) {
                        this.update();
                    }
                },
                update() {
                    const now = new Date();
                    const s = now.getSeconds() + now.getMilliseconds() / 1000;
                    const m = now.getMinutes() + s / 60;
                    const h = now.getHours() % 12 + m / 60;
                    this.hourHand.style.transform = `translateX(-50%) rotate(${(h / 12) * 360}deg)`;
                    this.minuteHand.style.transform = `translateX(-50%) rotate(${(m / 60) * 360}deg)`;
                    this.secondHand.style.transform = `translateX(-50%) rotate(${(s / 60) * 360}deg)`;
                    this.animationFrameId = requestAnimationFrame(() => this.update());
                }
            };
            
            // ===================================================================
            // LED 數字 SVG 產生器
            // ===================================================================
            function generateLedSvg(text, config = {}) {
                const { height = 24, color = '#FFFFFF', letterSpacing = 16 } = config;
                const id_suffix = Math.random().toString(36).substring(2, 9);
                const segmentId = `led-segment-${id_suffix}`;
                const colonId = `led-colon-${id_suffix}`;

                const segmentMap = [[1,1,1,1,1,1,0],[0,1,1,0,0,0,0],[1,1,0,1,1,0,1],[1,1,1,1,0,0,1],[0,1,1,0,0,1,1],[1,0,1,1,0,1,1],[1,0,1,1,1,1,1],[1,1,1,0,0,0,0],[1,1,1,1,1,1,1],[1,1,1,1,0,1,1]];
                const segmentTransforms = ['translate(0, 0)','translate(132, 20) rotate(90)','translate(132, 140) rotate(90)','translate(0, 240)','translate(12, 140) rotate(90)','translate(12, 20) rotate(90)','translate(0, 120)'];
                
                const digitBaseWidth = 144;
                const digitBaseHeight = 272;
                const colonBaseWidth = 48;

                let svgContent = '';
                let currentX = 0;

                for (const char of String(text)) {
                    if (/\d/.test(char)) {
                        const digit = parseInt(char, 10);
                        if (digit >= 0 && digit <= 9) {
                            const pattern = segmentMap[digit];
                            let digitGroup = `<g transform="translate(${currentX}, 0)">`;
                            for (let i = 0; i < 7; i++) {
                                digitGroup += `<use href="#${segmentId}" opacity="${pattern[i] ? '1' : '0.1'}" transform="${segmentTransforms[i]}" />`;
                            }
                            digitGroup += `</g>`;
                            svgContent += digitGroup;
                        }
                        currentX += digitBaseWidth + letterSpacing;
                    } else if (char === ':') {
                        svgContent += `<g transform="translate(${currentX}, 0)">
                            <use href="#${colonId}" transform="translate(0, 60)" />
                            <use href="#${colonId}" transform="translate(0, 180)" />
                        </g>`;
                        currentX += colonBaseWidth + letterSpacing;
                    }
                }
                const totalWidth = currentX > 0 ? currentX - letterSpacing : 0;
                if (totalWidth === 0) return '';
                
                const padding = 16;
                const finalWidth = ((totalWidth + padding * 2) / digitBaseHeight) * height;

                const svg = `<svg viewBox="-${padding} 0 ${totalWidth + padding * 2} ${digitBaseHeight}" data-text="${text}" height="${height}px" width="${finalWidth}px" fill="${color}" style="vertical-align: middle;"><defs><polygon id="${segmentId}" points="16 0, 96 0, 112 16, 96 32, 16 32, 0 16" /><rect id="${colonId}" x="-16" y="0" width="32" height="32" rx="5" ry="5" /></defs>${svgContent}</svg>`;
                return svg.replace(/\n\s*/g, '');
            }
            
            // ===================================================================
            // 統一的日曆標題渲染函數
            // ===================================================================
            function renderCalendarTitle(element, year, useLed, ledHeight, ledColor, defaultFontSize, defaultColor) {
                if (useLed) {
                    element.innerHTML = generateLedSvg(String(year), {height: ledHeight, color: ledColor});
                } else {
                    element.innerHTML = `<span style="font-size: ${defaultFontSize}; color: ${defaultColor}; line-height: 1; font-weight: 700;">${year}</span>`;
                }
            }


            // ===================================================================
            // 跑馬燈模組 (重構為 Class)
            // ===================================================================
            class MarqueeInstance {
                constructor(containerId, index) {
                    this.container = document.getElementById(containerId);
                    this.mainContainer = this.container.querySelector('main');
                    this.innerDiv = this.container.querySelector('.marquee-inner');
                    this.index = index;
                    this.animationStyleTag = document.createElement('style');
                    document.head.appendChild(this.animationStyleTag);
                    this.rebuildTimeout = null;
                    this.isScrolling = false; // 用於追蹤跑馬燈是否正在滾動
                }

                getReplacements() {
                    const now = new Date(); const year = now.getFullYear(); const month = now.getMonth() + 1; const day = now.getDate(); const hours = now.getHours(); const minutes = now.getMinutes(); const seconds = now.getSeconds(); const dayOfWeek = now.getDay(); const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六']; const dayOfWeekChars = ['日', '一', '二', '三', '四', '五', '六']; const amPm = hours >= 12 ? 'PM' : 'AM'; const h12 = hours % 12 || 12; const lunar = getLunarDate(now); const moonDetails = lunar ? (moonPhaseData[lunar.day] || { n: '未知', a: '' }) : { n: '', a: '' }; const moonName = moonDetails.a ? `${moonDetails.n}(${moonDetails.a})` : moonDetails.n; const yearGZ = tiangan.charAt((lunar.year - 4) % 10) + dizhi.charAt((lunar.year - 4) % 12); const yearSX = shengxiao.charAt((lunar.year - 4) % 12); const pad = (num) => String(num).padStart(2, '0'); const periodText = TimeHelper.getPeriodText(hours);
                    const shichen = ShichenHelper.getData(now);
                    let weatherReplacements = { '%WEATHER_LOC%': Weather.getChineseLocationName(settingsState.location), '%WEATHER_DESC%': '讀取中', '%TEMP%': '...', '%SUNRISE%': '...', '%SUNSET%': '...' };
                    if (Weather.data) { const formatTime = (dateStr) => dateStr ? new Date(dateStr).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : 'N/A'; weatherReplacements = { '%WEATHER_LOC%': Weather.getChineseLocationName(settingsState.location), '%WEATHER_DESC%': Weather.getWeatherDescription(Weather.data.current.weather_code), '%TEMP%': Math.round(Weather.data.current.temperature_2m), '%SUNRISE%': formatTime(Weather.data.daily.sunrise[0]), '%SUNSET%': formatTime(Weather.data.daily.sunset[0]), }; }
                    return { '%YYYY%': year, '%ROC_YY%': year - 1911, '%YY%': String(year).slice(-2), '%MM%': pad(month), '%M%': month, '%DD%': pad(day), '%D%': day, '%WEEKDAY%': weekdays[dayOfWeek], '%W_NUM%': dayOfWeek, '%W_SHORT%': `週${dayOfWeekChars[dayOfWeek]}`, '%W_CHAR%': dayOfWeekChars[dayOfWeek], '%L_GZ%': yearGZ, '%L_SX%': yearSX, '%LM_C%': lunar ? lunar.toString.split(/月/)[0] + '月' : '', '%LD_C%': lunar ? lunar.dayString : '', '%HH%': pad(hours), '%H%': hours, '%hh%': pad(h12), '%h%': h12, '%mm%': pad(minutes), '%m%': minutes, '%ss%': pad(seconds), '%s%': seconds, '%AP%': amPm, '%ap%': amPm.toLowerCase(), '%ap_c%': periodText, ...weatherReplacements, '%MOON_PHASE%': moonName, '%MOON_ICON%': lunar ? MoonPhaseWidget.getMoonPhaseSVG(lunar.day, '1em', `marquee-${this.index}`) : '', '%MOON_DAY%': lunar ? lunar.day : '', '%SHICHEN_GZ%': shichen.gz, '%SHICHEN_NAME%': shichen.name, '%SHICHEN_CHAR%': shichen.char };
                }
                buildInitialHTML(text) {
                    const settings = settingsState.marquees[this.index];
                    const isVertical = settings.vertical;
                    const defaultColor = (settings.colors && settings.colors.default) ? settings.colors.default : '#FFFFFF';
                    const replacements = this.getReplacements();
                    const paramRegex = new RegExp(`%C\\(#([0-9a-fA-F]{6}),\\s*([^%)]+)\\)%|${Object.keys(replacements).map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')}|%br%`, 'g');
                    let resultHTML = '';
                    let lastIndex = 0;
                    let match;
                    const useLedGlobal = settingsState.marqueeGlobal?.useLedFont ?? true;
                    const ledParams = ['%HH%', '%H%', '%hh%', '%h%', '%mm%', '%m%', '%ss%', '%s%', '%ROC_YY%', '%YYYY%', '%YY%', '%MM%', '%M%', '%DD%', '%D%', '%TEMP%', '%SUNRISE%', '%SUNSET%'];

                    while ((match = paramRegex.exec(text)) !== null) {
                        if (match.index > lastIndex) {
                            const plainText = text.substring(lastIndex, match.index);
                            resultHTML += `<span class="marquee-plain-text" style="color:${defaultColor}">${plainText.replace(/ /g, '\u00A0')}</span>`;
                        }

                        const param = match[0];
                        const colorHex = match[1];
                        const colorText = match[2];

                        if (colorHex && colorText) {
                            if (useLedGlobal && /^[\d:]+$/.test(colorText)) {
                                const widgetState = transformStates[this.container.id];
                                const svgHeight = widgetState ? widgetState.height * 0.70 : 28; 
                                const svgHTML = generateLedSvg(colorText, { height: svgHeight, color: '#' + colorHex });
                                resultHTML += `<span>${svgHTML}</span>`;
                            } else {
                                resultHTML += `<span class="marquee-plain-text" style="color:#${colorHex}">${colorText.replace(/ /g, '\u00A0')}</span>`;
                            }
                        } else if (param === '%br%') {
                            if (isVertical) {
                                resultHTML += '</div><div>';
                            }
                        } else {
                            const cssVar = marqueeParamColorMap[param];
                            const color = cssVar ? getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim() : defaultColor;
                            const replacementContent = String(replacements[param] || '');
                            
                            if (useLedGlobal && ledParams.includes(param) && /^[\d:]+$/.test(replacementContent)) {
                                const widgetState = transformStates[this.container.id];
                                const svgHeight = widgetState ? widgetState.height * 0.70 : 28; 
                                const svgHTML = generateLedSvg(replacementContent, { height: svgHeight, color: color });
                                resultHTML += `<span data-time-key="${param}">${svgHTML}</span>`;
                            } else if (param === '%MOON_ICON%') {
                                resultHTML += `<span data-time-key="${param}">${replacementContent}</span>`;
                            } else {
                                resultHTML += `<span data-time-key="${param}" style="color:${color}">${replacementContent}</span>`;
                            }
                        }
                        lastIndex = paramRegex.lastIndex;
                    }

                    if (lastIndex < text.length) {
                        const remainingText = text.substring(lastIndex);
                        resultHTML += `<span class="marquee-plain-text" style="color:${defaultColor}">${remainingText.replace(/ /g, '\u00A0')}</span>`;
                    }
                    return isVertical ? `<div>${resultHTML}</div>` : resultHTML;
                }

                updateContent() {
                    const replacements = this.getReplacements();
                    this.innerDiv.querySelectorAll('[data-time-key]').forEach(span => {
                        const key = span.dataset.timeKey;
                        if (replacements[key] === undefined) return;
                        const useLed = settingsState.marqueeGlobal?.useLedFont ?? true;
                        const ledParams = ['%HH%', '%H%', '%hh%', '%h%', '%mm%', '%m%', '%ss%', '%s%', '%ROC_YY%', '%YYYY%', '%YY%', '%MM%', '%M%', '%DD%', '%D%', '%TEMP%', '%SUNRISE%', '%SUNSET%'];
                        const newText = String(replacements[key]);
                        
                        if (useLed && ledParams.includes(key) && /^[\d:]+$/.test(newText)) {
                            const svgEl = span.querySelector('svg');
                            if (!svgEl || svgEl.dataset.text !== newText) {
                                 const widgetState = transformStates[this.container.id];
                                 const svgHeight = widgetState ? widgetState.height * 0.70 : 28;
                                 const color = svgEl ? svgEl.getAttribute('fill') : (marqueeParamColorMap[key] ? getComputedStyle(document.documentElement).getPropertyValue(marqueeParamColorMap[key]).trim() : '#FFFFFF');
                                 span.innerHTML = generateLedSvg(newText, { height: svgHeight, color: color });
                            }
                        } else if (key === '%MOON_ICON%') {
                            if (span.innerHTML !== newText) span.innerHTML = newText;
                        } else {
                            if (span.textContent !== newText) span.textContent = newText;
                        }
                    });
                }

                rebuildAnimation() {
                    clearTimeout(this.rebuildTimeout);
                    this.innerDiv.style.animation = '';
                    this.isScrolling = false;
                    const settings = settingsState.marquees[this.index];
                    if (!settings) return;

                    const hasWeatherParams = settings.text && /%WEATHER_|%SUNRISE%|%SUNSET%|%TEMP%/.test(settings.text);
                    if (hasWeatherParams && !weatherDataLoaded) {
                        this.innerDiv.style.transform = 'translateX(0) translateY(0)';
                        const staticContent = this.buildInitialHTML(settings.text);
                        this.innerDiv.innerHTML = `<div class="marquee-text-instance">${staticContent}</div>`;
                        return;
                    }

                    this.rebuildTimeout = setTimeout(() => {
                        this.animationStyleTag.innerHTML = '';
                        this.innerDiv.innerHTML = '';
                        this.innerDiv.style.transform = 'translateX(0) translateY(0) translateZ(0)';

                        if (!settings.text || !settings.text.trim()) return;

                        const { text, vertical: isVertical, speed, direction } = settings;
                        this.innerDiv.style.flexDirection = isVertical ? 'column' : 'row';
                        this.innerDiv.style.width = isVertical ? '100%' : 'fit-content';
                        this.mainContainer.style.alignItems = isVertical ? 'flex-start' : 'center';

                        const instance1 = document.createElement('div');
                        instance1.className = 'marquee-text-instance';
                        instance1.style.whiteSpace = isVertical ? 'normal' : 'nowrap';
                        instance1.style.textAlign = isVertical ? 'center' : 'left';
                        instance1.innerHTML = this.buildInitialHTML(text);
                        this.innerDiv.appendChild(instance1);
                        instance1.getBoundingClientRect();

                        const contentMeasure = isVertical ? instance1.offsetHeight : instance1.offsetWidth;
                        const containerMeasure = isVertical ? this.mainContainer.offsetHeight : this.mainContainer.offsetWidth;

                        if (contentMeasure <= containerMeasure) {
                            this.isScrolling = false;
                            if (!isVertical) {
                                const containerWidth = this.mainContainer.clientWidth;
                                const contentWidth = instance1.scrollWidth;
                                if (contentWidth > containerWidth) {
                                    let currentFontSize = parseFloat(getComputedStyle(this.container).fontSize);
                                    let newFontSize = currentFontSize * (containerWidth / contentWidth) * 0.98;
                                    this.container.style.fontSize = `${newFontSize}px`;
                                }
                            }
                            return;
                        }
                        
                        this.isScrolling = true;
                        this.innerDiv.appendChild(instance1.cloneNode(true));

                        const travelDistance = contentMeasure;
                        if (travelDistance <= 0) return;
                        const duration = travelDistance / (parseInt(speed, 10) || 80);
                        const animName = `marquee-${this.index}-${Date.now()}`;
                        let fromTransform, toTransform;
                        switch(direction) {
                            case 'right': fromTransform = `translateX(-${travelDistance}px)`; toTransform = `translateX(0px)`; break;
                            case 'up': fromTransform = `translateY(0px)`; toTransform = `translateY(-${travelDistance}px)`; break;
                            case 'down': fromTransform = `translateY(-${travelDistance}px)`; toTransform = `translateY(0px)`; break;
                            default: fromTransform = `translateX(0px)`; toTransform = `translateX(-${travelDistance}px)`; break;
                        }

                        this.animationStyleTag.innerHTML = `@keyframes ${animName} { from { transform: ${fromTransform} translateZ(0); } to { transform: ${toTransform} translateZ(0); }}`;
                        this.innerDiv.style.animation = `${animName} ${duration}s linear infinite`;
                        this.innerDiv.style.animationPlayState = isEditMode ? 'paused' : 'running';
                    }, 50);
                }

                 setPlayState(shouldPlay) {
                    this.innerDiv.style.animationPlayState = shouldPlay ? 'running' : 'paused';
                }
            }
            const MarqueeManager = {
                instances: [],
                init() {
                    document.querySelectorAll('.marquee-widget').forEach((el, i) => {
                        this.instances.push(new MarqueeInstance(el.id, i));
                    });
                    setInterval(() => this.updateAllContent(), 1000);
                },
                updateAllContent() { this.instances.forEach(inst => inst.updateContent()); },
                rebuildAllAnimations() { this.instances.forEach(inst => inst.rebuildAnimation()); },
                rebuildAnimationByIndex(index) { if (this.instances[index]) this.instances[index].rebuildAnimation(); },
                setPlayState(shouldPlay) { this.instances.forEach(inst => inst.setPlayState(shouldPlay)); }
            };

            // ===================================================================
            // 天氣模組
            // ===================================================================
            const Weather = {
                data: null, init() { this.updateWeather(); setInterval(() => this.updateWeather(), 15 * 60 * 1000); },
                async fetchAPI(url) { try { const response = await fetch(url); if (!response.ok) throw new Error('API請求失敗'); return await response.json(); } catch (error) { console.error(`獲取資料失敗: ${url}`, error); return null; } },
                async fetchCoordinates(name) { const data = await this.fetchAPI(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`); return data?.results?.[0] || null; },
                async fetchWeather(lat, lon) { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=weather_code,sunrise,sunset&timezone=auto`; return await this.fetchAPI(url); },
                async updateWeather() {
                    const locationName = settingsState.location?.trim();
                    if (!locationName) {
                        this.data = null;
                        weatherDataLoaded = true; // 標記為已載入
                        MarqueeManager.rebuildAllAnimations();
                        return;
                    }
                    const coords = await this.fetchCoordinates(locationName);
                    this.data = coords ? await this.fetchWeather(coords.latitude, coords.longitude) : null;
                    weatherDataLoaded = true; // 標記為已載入
                    MarqueeManager.rebuildAllAnimations();
                },
                getWeatherDescription(code) { const map={0:"晴",1:"多雲時晴",2:"局部多雲",3:"陰",45:"霧",48:"凍霧",51:"毛毛雨",53:"毛毛雨",55:"毛毛雨",56:"凍毛毛雨",57:"凍毛毛雨",61:"雨",63:"雨",65:"大雨",66:"凍雨",67:"凍雨",71:"雪",73:"雪",75:"大雪",77:"冰雹",80:"陣雨",81:"陣雨",82:"大陣雨",85:"陣雪",86:"大陣雪",95:"雷陣雨",96:"雷陣雨伴冰雹",99:"雷陣雨伴冰雹"}; return map[code] || "未知"; },
                getChineseLocationName(englishName) {
                    if (!englishName) return '';
                    for (const county in taiwanLocations) {
                        if (taiwanLocations[county].english.toLowerCase() === englishName.toLowerCase()) return county;
                        for (const district in taiwanLocations[county].districts) {
                            if (taiwanLocations[county].districts[district].toLowerCase() === englishName.toLowerCase()) {
                                return district === county ? county : `${county}${district}`;
                            }
                        }
                    }
                    return englishName.charAt(0).toUpperCase() + englishName.slice(1);
                }
            };
            // ===================================================================
            // 月相模組
            // ===================================================================
            const MoonPhaseWidget = { yearHeader: document.getElementById('moon-phase-year-header'), backgroundMonth: document.getElementById('moon-background-month'), body: document.getElementById('moon-calendar-body'), currentDate: new Date(), init() { this.render(); document.getElementById('moon-phase-prev-month').addEventListener('click', () => { if(!isEditMode) { this.currentDate.setMonth(this.currentDate.getMonth() - 1); this.render(); } }); document.getElementById('moon-phase-next-month').addEventListener('click', () => { if(!isEditMode) { this.currentDate.setMonth(this.currentDate.getMonth() + 1); this.render(); } }); document.getElementById('moon-phase-today').addEventListener('click', () => { if(!isEditMode) { this.currentDate = new Date(); this.render(); } }); }, getMoonPhaseSVG(lunarDay, size = '100px', context = 'widget') { const phase = (lunarDay - 1) / 29.53, r = 50, cx = 50, cy = 50; const light = getComputedStyle(document.documentElement).getPropertyValue('--moon-light-color').trim() || '#f0e68c'; const dark = getComputedStyle(document.documentElement).getPropertyValue('--moon-dark-color').trim() || '#222222'; const cos_angle = Math.cos(phase * 2 * Math.PI + Math.PI); const base = phase > 0.5 ? `<rect x="0" y="0" width="${cx}" height="${r*2}" fill="${light}" /><rect x="${cx}" y="0" width="${cx}" height="${r*2}" fill="${dark}" />` : `<rect x="0" y="0" width="${cx}" height="${r*2}" fill="${dark}" /><rect x="${cx}" y="0" width="${cx}" height="${r*2}" fill="${light}" />`; const terminator = `<ellipse cx="${cx}" cy="${cy}" rx="${r * Math.abs(cos_angle)}" ry="${r}" fill="${cos_angle > 0 ? light : dark}" />`; const id = `moon-clip-${context}-${lunarDay}-${size.replace(/[^a-zA-Z0-9]/g, '')}`; return `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="filter: drop-shadow(0 0 10px ${light}33);"><defs><clipPath id="${id}"><circle cx="${cx}" cy="${cy}" r="${r}" /></clipPath></defs><g clip-path="url(#${id})">${base}${terminator}</g></svg>`; }, render() { this.body.innerHTML = ''; const year = this.currentDate.getFullYear(); const month = this.currentDate.getMonth(); const useLedHeader = settingsState.moonPhase?.useLedFont ?? true; const yearColor = getComputedStyle(document.documentElement).getPropertyValue('--year-color').trim() || '#FF3333'; renderCalendarTitle(this.yearHeader, year, useLedHeader, 26, yearColor, '26px', yearColor); this.backgroundMonth.textContent = month + 1; const firstDayOfMonth = new Date(year, month, 1); const startDayOfWeek = firstDayOfMonth.getDay(); const startDate = new Date(year, month, 1 - startDayOfWeek); const today = new Date(); today.setHours(0,0,0,0); for (let i = 0; i < 42; i++) { const cellDate = new Date(startDate); cellDate.setDate(startDate.getDate() + i); const lunar = getLunarDate(cellDate); const cell = document.createElement('div'); cell.className = `calendar-day ${cellDate.getMonth() !== month ? 'other-month' : ''} ${cellDate.getTime() === today.getTime() ? 'today' : ''}`; 
                const useLed = settingsState.moonPhase?.useLedFont ?? true;
                const dayColor = getComputedStyle(document.documentElement).getPropertyValue('--day-color').trim() || '#ffffff';
                const date = cellDate.getDate();
                const dayNumberHTML = useLed
                    ? `<div class="day-number-wrapper">${generateLedSvg(String(date), { height: 20, color: dayColor })}</div>`
                    : `<div class="day-number-wrapper" style="font-size: 1.2em; line-height: 1; color: ${dayColor}; font-weight: bold;">${date}</div>`;
                const lunarDateText = lunar.day === 1 ? lunar.toString.substring(0, lunar.isLeap ? 3 : 2) : lunar.dayString;
                cell.innerHTML = `
                    ${dayNumberHTML}
                    <div class="moon-icon-small">${this.getMoonPhaseSVG(lunar.day, '100%', `grid-${i}`)}</div>
                    <div class="lunar-date">${lunarDateText}</div>
                `;
                cell.addEventListener('click', () => { if(!isEditMode) showDayDetailModal(cellDate.toISOString()); }); this.body.appendChild(cell); } } };

            // ===================================================================
            // Modal 和 UI 互動
            // ===================================================================
            function showModal(modalId) { document.getElementById(modalId).classList.add('show'); }
            function hideModal(modalId) { document.getElementById(modalId).classList.remove('show'); }
            const promptModal=document.getElementById('modal-backdrop-prompt'),promptTitle=document.getElementById('prompt-title'),promptMessage=document.getElementById('prompt-message'),promptInput=document.getElementById('prompt-input'),promptOkBtn=document.getElementById('prompt-ok-btn'),promptCancelBtn=document.getElementById('prompt-cancel-btn');
            let promptCallback=null;

            function showAlert(title, message) {
                promptTitle.textContent = title;
                promptMessage.textContent = message;
                promptMessage.style.display = 'block';
                promptInput.style.display = 'none';
                promptCancelBtn.style.display = 'none';
                promptCallback = null;
                showModal('modal-backdrop-prompt');
            }
            function showPrompt(title, message, defaultValue, callback) {
                promptTitle.textContent = title;
                promptMessage.textContent = message;
                promptMessage.style.display = message ? 'block' : 'none';
                promptInput.style.display = 'block';
                promptCancelBtn.style.display = 'inline-block';
                promptInput.value = defaultValue;
                promptCallback = callback;
                showModal('modal-backdrop-prompt');
                setTimeout(() => promptInput.focus(), 100);
            }

            promptOkBtn.addEventListener('click',()=>{if(promptCallback){promptCallback(promptInput.value)}hideModal('modal-backdrop-prompt')});
            promptCancelBtn.addEventListener('click',()=>{if(promptCallback){promptCallback(null)}hideModal('modal-backdrop-prompt')});
            function showDayDetailModal(dateString){
                if(isEditMode)return;
                const date=new Date(dateString);
                const lunar=getLunarDate(date);
                const holiday=getHoliday(date);
                const solarTerm=getSolarTerm(date.getFullYear(),date.getMonth()+1,date.getDate());
                const useLed = settingsState.calendar?.useLedFont ?? true;

                if (useLed) {
                    const yearSVG = generateLedSvg(String(date.getFullYear()), {height: 22, color: 'white'});
                    const monthSVG = generateLedSvg(String(date.getMonth() + 1), {height: 22, color: 'white'});
                    const daySVG = generateLedSvg(String(date.getDate()), {height: 22, color: 'white'});
                    document.getElementById('modal-gregorian-date').innerHTML = `${yearSVG}<span class="led-text-unit-modal">年</span>${monthSVG}<span class="led-text-unit-modal">月</span>${daySVG}<span class="led-text-unit-modal">日 星期${"日一二三四五六"[date.getDay()]}</span>`;
                } else {
                     document.getElementById('modal-gregorian-date').innerHTML = `<span style="font-size: 1.5em; line-height:1.2;">${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 星期${"日一二三四五六"[date.getDay()]}</span>`;
                }

                const rocYear = date.getFullYear()-1911;
                const rocYearHTML = useLed ? generateLedSvg(String(rocYear), {height: 20, color: '#a5b4fc'}) : rocYear;
                document.getElementById('modal-lunar-date').innerHTML = `民國 ${rocYearHTML} 年 / 農曆 ${lunar.toString}`;

                const modalHolidayEl=document.getElementById('modal-holiday');
                modalHolidayEl.textContent=holiday||'';
                modalHolidayEl.style.display=holiday?'block':'none';
                if(holiday)modalHolidayEl.dataset.key=holiday;
                const modalSolarTermEl=document.getElementById('modal-solarterm');
                modalSolarTermEl.textContent=solarTerm||'';
                modalSolarTermEl.style.display=solarTerm?'block':'none';
                if(solarTerm)modalSolarTermEl.dataset.key=solarTerm;
                
                const formatTime = (dateStr) => dateStr ? new Date(dateStr).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '讀取中...';
                const sunriseTime = Weather.data?.daily?.sunrise?.[0] ? formatTime(Weather.data.daily.sunrise[0]) : '讀取中...';
                const sunsetTime = Weather.data?.daily?.sunset?.[0] ? formatTime(Weather.data.daily.sunset[0]) : '讀取中...';
                const isTimeFormat = (str) => /^[\d:]+$/.test(str);

                document.getElementById('modal-sunrise-time').innerHTML = useLed && isTimeFormat(sunriseTime) ? generateLedSvg(sunriseTime, {height: 26, color: 'white'}) : sunriseTime;
                document.getElementById('modal-sunset-time').innerHTML = useLed && isTimeFormat(sunsetTime) ? generateLedSvg(sunsetTime, {height: 26, color: 'white'}) : sunsetTime;

                const moonDetails = moonPhaseData[lunar.day] || { n: '未知', a: '' };
                const moonName = moonDetails.a ? `${moonDetails.n}(${moonDetails.a})` : moonDetails.n;
                document.getElementById('modal-moon-icon').innerHTML = MoonPhaseWidget.getMoonPhaseSVG(lunar.day, '64px', 'day-detail');
                document.getElementById('modal-moon-phase-name').textContent = moonName;

                updateCountdowns(date);
                showModal('modal-backdrop-day')
            }
            function showExplanationModal(title,content){if(isEditMode)return;document.getElementById('explanation-title').textContent=title;document.getElementById('explanation-content').textContent=content;showModal('modal-backdrop-explanation')}
            function getAllSolarTermsForYear(year){if(!solarTermsCache[year])calculateAndCacheSolarTerms(year);return Object.entries(solarTermsCache[year]).map(([key,name])=>{const[y,m,d]=key.split('-').map(Number);return{date:new Date(y,m-1,d),name}}).sort((a,b)=>a.date-b.date)}
            function getAllHolidaysForYear(year){
                let holidays = [];
                // 1. Gregorian Holidays
                Object.entries(gregorianHolidays).forEach(([key, name]) => {
                    const [m, d] = key.split('-');
                    holidays.push({ date: new Date(year, parseInt(m) - 1, parseInt(d)), name });
                });

                // 2. Lunar Holidays
                Object.entries(lunarHolidays).forEach(([key, name]) => {
                    [year, year - 1].forEach(lunarYear => {
                        const [m, d] = key.split('-');
                        const solarDate = lunarToSolar(lunarYear, parseInt(m), parseInt(d));
                        if (solarDate && solarDate.getFullYear() === year) {
                            holidays.push({ date: solarDate, name });
                        }
                    });
                });

                // Add Lunar New Year's Eve separately
                [year, year - 1].forEach(lunarYear => {
                    const lastDay = getLunarMonthDays(lunarYear, 12);
                    const eveDate = lunarToSolar(lunarYear, 12, lastDay);
                    if (eveDate && eveDate.getFullYear() === year) {
                        holidays.push({ date: eveDate, name: "除夕" });
                    }
                });

                // 3. Floating Holidays
                Object.entries(floatingHolidays).forEach(([key, name]) => {
                    const [m, week, dayOfWeek] = key.split('-').map(Number);
                    const month = m - 1;
                    let firstOfMonth = new Date(year, month, 1);
                    let dateOfFirstDayOfWeek = 1 + ((dayOfWeek - firstOfMonth.getDay() + 7) % 7);
                    let holidayDate = new Date(year, month, dateOfFirstDayOfWeek + (week - 1) * 7);
                    if (holidayDate.getMonth() === month) {
                        holidays.push({ date: holidayDate, name });
                    }
                });

                const uniqueHolidays = Array.from(new Map(holidays.map(h => [h.date.toISOString().split('T')[0], h])).values());
                return uniqueHolidays.sort((a, b) => a.date - b.date);
            }
            function updateCountdowns(currentDate){
                const today = new Date(currentDate);
                today.setHours(0,0,0,0);
                const useLed = settingsState.calendar?.useLedFont ?? true;

                const formatCountdownText=(items,type)=>{
                    const futureEvents=items.filter(item=>item.date>=today);
                    if(futureEvents.length===0)return`找不到${today.getFullYear()+1}年的${type}資料`;
                    
                    const firstEvent=futureEvents[0];
                    const diffDays=Math.ceil((firstEvent.date.getTime()-today.getTime())/86400000);
                    const daysHTML = useLed ? generateLedSvg(String(diffDays), {height: 20, color: 'white'}) : `<span style="font-size: 1.2em;">${diffDays}</span>`;
                    
                    if(diffDays===0){
                        if(futureEvents[1]) {
                             const nextDiffDays = Math.ceil((futureEvents[1].date - today) / 86400000);
                             const nextDaysHTML = useLed ? generateLedSvg(String(nextDiffDays), {height: 20, color: 'white'}) : `<span style="font-size: 1.2em;">${nextDiffDays}</span>`;
                             return `<div class="countdown-text-container">今天是 ${firstEvent.name}，距離下個${type} [${futureEvents[1].name}] 還有 ${nextDaysHTML} 天</div>`;
                        }
                        return `今天是 ${firstEvent.name}！`;
                    }
                    return `<div class="countdown-text-container">距離 ${firstEvent.name} 還有 ${daysHTML} 天</div>`;
                };
                let allHolidays=[...getAllHolidaysForYear(today.getFullYear()),...getAllHolidaysForYear(today.getFullYear()+1)];
                let allSolarTerms=[...getAllSolarTermsForYear(today.getFullYear()),...getAllSolarTermsForYear(today.getFullYear()+1)];
                document.getElementById('countdown-holiday-text').innerHTML=formatCountdownText(allHolidays,'節日');
                document.getElementById('countdown-solarterm-text').innerHTML=formatCountdownText(allSolarTerms,'節氣');
            }
            const pickerYearEl=document.getElementById('picker-year'),pickerMonthGridEl=document.getElementById('picker-month-grid');
            let pickerYear=new Date().getFullYear();
            let pickerTarget = null; 

            function renderPicker(year, month, targetDate) {
                pickerYear = year;
                pickerYearEl.textContent = year;
                pickerMonthGridEl.innerHTML = '';
                for (let i = 0; i < 12; i++) {
                    const cell = document.createElement('div');
                    cell.textContent = `${i + 1}月`;
                    cell.classList.add('month-cell');
                    if (i === month && year === targetDate.getFullYear()) {
                        cell.classList.add('selected');
                    }
                    cell.dataset.month = i;
                    pickerMonthGridEl.appendChild(cell);
                }
            }

            function openPickerFor(targetWidget) {
                if (isEditMode) return;
                pickerTarget = targetWidget;
                renderPicker(pickerTarget.currentDate.getFullYear(), pickerTarget.currentDate.getMonth(), pickerTarget.currentDate);
                showModal('modal-backdrop-picker');
            }
            document.getElementById('year-header').addEventListener('click', () => openPickerFor(Calendar));
            document.getElementById('moon-phase-year-header').addEventListener('click', () => openPickerFor(MoonPhaseWidget));

            document.getElementById('picker-prev-year').addEventListener('click', () => {
                if (pickerYear > 1900 && pickerTarget) {
                    pickerYear--;
                    renderPicker(pickerYear, -1, pickerTarget.currentDate);
                }
            });
            document.getElementById('picker-next-year').addEventListener('click', () => {
                if (pickerYear < 2100 && pickerTarget) {
                    pickerYear++;
                    renderPicker(pickerYear, -1, pickerTarget.currentDate);
                }
            });
            pickerMonthGridEl.addEventListener('click', (e) => {
                const cell = e.target.closest('.month-cell');
                if (cell && pickerTarget) {
                    pickerTarget.currentDate = new Date(pickerYear, cell.dataset.month, 1);
                    pickerTarget.render();
                    hideModal('modal-backdrop-picker');
                }
            });

            document.body.addEventListener('click',(e)=>{const cell=e.target.closest('.calendar-day');const key=e.target.dataset.key;if(key&&explanations[key]){e.stopPropagation();showExplanationModal(key,explanations[key]);return}if(cell&&cell.closest('#calendar-body')&&cell.dataset.date){showDayDetailModal(cell.dataset.date)}const closeModalBtn=e.target.closest('[data-close-modal]');if(closeModalBtn){hideModal(closeModalBtn.dataset.closeModal)}if(e.target.classList.contains('modal-backdrop')){hideModal(e.target.id)}});
            document.getElementById('marquee-params-btn').addEventListener('click', () => showModal('modal-backdrop-marquee-params'));
            document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){['modal-backdrop-day','modal-backdrop-picker','modal-backdrop-explanation','modal-backdrop-settings','modal-backdrop-prompt', 'modal-backdrop-marquee-params'].forEach(hideModal)}});

            function resetActivityTimeout(){actionButtons.classList.remove('hidden');clearTimeout(activityTimeout);if(!isEditMode){activityTimeout=setTimeout(()=>actionButtons.classList.add('hidden'),3000)}}
            ['mousemove','mousedown','touchstart','keydown'].forEach(event=>document.addEventListener(event,resetActivityTimeout));
            document.getElementById('fullscreen-btn').addEventListener('click',()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen()}else{document.exitFullscreen()}});
            document.addEventListener('fullscreenchange',()=>{const isFullscreen=!!document.fullscreenElement;document.getElementById('fullscreen-enter-icon').classList.toggle('display-none',isFullscreen);document.getElementById('fullscreen-exit-icon').classList.toggle('display-none',!isFullscreen)});
            // ===================================================================
            // 設定、顏色與儲存
            // ===================================================================
            function applyDefaultSettings() {
                applyLayout(JSON.parse(JSON.stringify(userDefaultLayout)));
                saveCurrentSettings();
                Weather.updateWeather();
            }
            function applyAllSettings() {
                Object.keys(settingsState).forEach(widgetKey => {
                    if (settingsState[widgetKey] && settingsState[widgetKey].colors) {
                        Object.entries(settingsState[widgetKey].colors).forEach(([key, value]) => {
                            document.documentElement.style.setProperty(key, value);
                        });
                    }
                });
                applyAllTransforms();
                updateSettingsUIFromState();
                if(Calendar) Calendar.render();
                if(MoonPhaseWidget) MoonPhaseWidget.render();
                if(AnalogClock) AnalogClock.init();
                MarqueeManager.rebuildAllAnimations();
            }

            function saveCurrentSettings() {
                localStorage.setItem('widgets_autosave', JSON.stringify({
                    transforms: transformStates,
                    settings: settingsState
                }));
            }
            function updateSettingsUIFromState() {
                document.querySelectorAll('#modal-backdrop-settings input[data-setting-type="color"]').forEach(picker => {
                    const widget = picker.dataset.widget;
                    const cssVar = picker.dataset.var;
                    if (settingsState[widget] && settingsState[widget].colors && settingsState[widget].colors[cssVar]) {
                        picker.value = settingsState[widget].colors[cssVar];
                    } else {
                        const style = getComputedStyle(document.documentElement);
                        picker.value = style.getPropertyValue(cssVar).trim() || '#ffffff';
                    }
                });
                document.querySelectorAll('input[data-widget-toggle]').forEach(toggle => {
                    const id = toggle.dataset.widgetToggle;
                    toggle.checked = transformStates[id]?.visible ?? false;
                });
                document.querySelectorAll('#modal-backdrop-settings input[data-setting-type="toggle"]').forEach(toggle => {
                    const widget = toggle.dataset.widget;
                    const key = toggle.dataset.key;
                    if (settingsState[widget] && typeof settingsState[widget][key] !== 'undefined') {
                        toggle.checked = settingsState[widget][key];
                    }
                });
                updateLocationSelectors();
                loadMarqueeSettingsToUI(document.getElementById('marquee-selector').value);
                // 更新定時特效 UI
                const teSettings = settingsState.timedEffect;
                if (teSettings) {
                    document.getElementById('timed-effect-enabled-toggle').checked = teSettings.enabled;
                    document.getElementById('timed-effect-interval-seconds').value = teSettings.intervalSeconds;
                }
            }

            // --- Marquee 設定 UI ---
            const marqueeSelector = document.getElementById('marquee-selector');
            const marqueeTextInput = document.getElementById('marquee-text-input');
            const marqueeSpeedInput = document.getElementById('marquee-speed-input');
            const marqueeVerticalToggle = document.getElementById('marquee-vertical-toggle');
            const marqueeEnabledToggle = document.getElementById('marquee-enabled-toggle');
            const marqueeColorInput = document.getElementById('marquee-default-color');
            const marqueeDirectionSelect = document.getElementById('marquee-direction-select');

            for (let i = 0; i < 6; i++) {
                marqueeSelector.add(new Option(`${i+1}`, i));
            }
            ['left', 'right', 'up', 'down'].forEach(dir => {
                const text = {'left':'左', 'right':'右', 'up':'上', 'down':'下'}[dir];
                marqueeDirectionSelect.add(new Option(text, dir));
            });

            function updateDirectionOptions(isVertical) {
                for (const option of marqueeDirectionSelect.options) {
                    const isVerticalOption = ['up', 'down'].includes(option.value);
                    option.disabled = isVertical ? !isVerticalOption : isVerticalOption;
                }
            }
            function loadMarqueeSettingsToUI(index) {
                const settings = settingsState.marquees[index];
                if (!settings) return;
                marqueeTextInput.value = settings.text;
                marqueeSpeedInput.value = settings.speed;
                marqueeVerticalToggle.checked = settings.vertical;
                marqueeEnabledToggle.checked = transformStates[`marquee-container-${index}`]?.visible ?? false;
                marqueeDirectionSelect.value = settings.direction || (settings.vertical ? 'up' : 'left');
                marqueeColorInput.value = (settings.colors && settings.colors.default) ? settings.colors.default : '#FFFFFF';
                updateDirectionOptions(settings.vertical);
            }

            marqueeSelector.addEventListener('change', (e) => loadMarqueeSettingsToUI(e.target.value));
            function updateMarqueeSettingFromUI() {
                const index = marqueeSelector.value;
                if (!settingsState.marquees[index]) return;
                settingsState.marquees[index].text = marqueeTextInput.value;
                settingsState.marquees[index].speed = marqueeSpeedInput.value;
                settingsState.marquees[index].vertical = marqueeVerticalToggle.checked;
                settingsState.marquees[index].direction = marqueeDirectionSelect.value;
                if (!settingsState.marquees[index].colors) {
                    settingsState.marquees[index].colors = {};
                }
                settingsState.marquees[index].colors['default'] = marqueeColorInput.value;
                MarqueeManager.rebuildAnimationByIndex(index);
                saveCurrentSettings();
            }

            marqueeVerticalToggle.addEventListener('change', e => {
                const isVertical = e.target.checked;
                updateDirectionOptions(isVertical);
                marqueeDirectionSelect.value = isVertical ? 'up' : 'left';
                updateMarqueeSettingFromUI();
            });
            marqueeEnabledToggle.addEventListener('change', e => {
                const index = marqueeSelector.value;
                const widgetId = `marquee-container-${index}`;
                const isVisible = e.target.checked;
                if (transformStates[widgetId]) {
                    transformStates[widgetId].visible = isVisible;
                    document.getElementById(widgetId).style.display = isVisible ? 'flex' : 'none';
                    const mainToggle = document.querySelector(`input[data-widget-toggle="${widgetId}"]`);
                    if (mainToggle) mainToggle.checked = isVisible;
                    saveCurrentSettings();
                }
            });

            ['input', 'change'].forEach(evt => {
                marqueeTextInput.addEventListener(evt, updateMarqueeSettingFromUI);
                marqueeSpeedInput.addEventListener(evt, updateMarqueeSettingFromUI);
                marqueeColorInput.addEventListener(evt, updateMarqueeSettingFromUI);
                marqueeDirectionSelect.addEventListener(evt, updateMarqueeSettingFromUI);
            });

            document.getElementById('settings-btn').addEventListener('click', () => {
                updateSettingsUIFromState();
                showModal('modal-backdrop-settings');
            });
            document.querySelector('#modal-backdrop-settings').addEventListener('input', e => {
                if (e.target.dataset.settingType === 'color') { 
                    const widget = e.target.dataset.widget;
                    const cssVar = e.target.dataset.var;
                    const color = e.target.value;
                    document.documentElement.style.setProperty(cssVar, color);
                    if (settingsState[widget]?.colors) {
                         settingsState[widget].colors[cssVar] = color;
                    }
                    if (widget === 'moonPhase') MoonPhaseWidget.render();
                    if (widget === 'calendar') Calendar.render(); 
                    if (widget === 'analogClock') AnalogClock.init(); // 顏色變更時重繪指針時鐘
                    MarqueeManager.rebuildAllAnimations();
                    saveCurrentSettings();
                }
            });

            document.querySelector('#modal-backdrop-settings').addEventListener('change', e => {
                const toggle = e.target.closest('input[data-widget-toggle]');
                if (toggle) {
                    const widgetId = toggle.dataset.widgetToggle;
                    const widgetEl = document.getElementById(widgetId);
                    if (widgetEl && transformStates[widgetId]) {
                        transformStates[widgetId].visible = toggle.checked;
                        widgetEl.style.display = toggle.checked ? 'flex' : 'none';
                        if (widgetId.startsWith('marquee-container-')) {
                            const selectedMarqueeIndex = marqueeSelector.value;
                            if (widgetId === `marquee-container-${selectedMarqueeIndex}`) {
                                marqueeEnabledToggle.checked = toggle.checked;
                            }
                        }
                        saveCurrentSettings();
                    }
                }
                const settingToggle = e.target.closest('input[data-setting-type="toggle"]');
                if (settingToggle) {
                    const widget = settingToggle.dataset.widget;
                    const key = settingToggle.dataset.key;
                    if (settingsState[widget]) {
                        settingsState[widget][key] = settingToggle.checked;
                        saveCurrentSettings();
                        if (widget === 'calendar') Calendar.render();
                        if (widget === 'analogClock') AnalogClock.init();
                        if (widget === 'moonPhase') MoonPhaseWidget.render();
                        if (widget === 'marqueeGlobal') MarqueeManager.rebuildAllAnimations();
                    }
                }
            });

            function getRandomHexColor() { return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0'); }
            function applyRandomColors() {
                document.querySelectorAll('#modal-backdrop-settings .color-picker').forEach(picker => {
                    const randomColor = getRandomHexColor();
                    picker.value = randomColor;
                    picker.dispatchEvent(new Event('input', { bubbles: true }));
                });
            }

            document.getElementById('random-colors-btn').addEventListener('click', applyRandomColors);
            document.getElementById('default-settings-btn').addEventListener('click', applyDefaultSettings);

            // ===================================================================
            // 編輯模式與拖曳縮放
            // ===================================================================
            document.getElementById('edit-layout-btn').addEventListener('click', () => {
                isEditMode = !isEditMode;
                // 2024-09-13: 取得定時特效的 UI 元件
                const timedEffectToggle = document.getElementById('timed-effect-enabled-toggle');
                const timedEffectInterval = document.getElementById('timed-effect-interval-seconds');

                if (isEditMode) {
                    MarqueeManager.setPlayState(false);
                    // 2024-09-13: 禁用定時特效選項
                    timedEffectToggle.disabled = true;
                    timedEffectInterval.disabled = true;
                } else {
                    MarqueeManager.setPlayState(true);
                    saveCurrentSettings(); 
                    editToolbar.style.left = '50%';
                    editToolbar.style.top = 'auto';
                    editToolbar.style.bottom = '';
                    editToolbar.style.transform = 'translateX(-50%)';
                    // 2024-09-13: 啟用定時特效選項
                    timedEffectToggle.disabled = false;
                    timedEffectInterval.disabled = false;
                }
                document.body.classList.toggle('edit-mode', isEditMode);
                allWidgetContainers().forEach(c => c.classList.toggle('edit-mode', isEditMode));
                document.getElementById('edit-icon').classList.toggle('display-none', isEditMode);
                document.getElementById('edit-exit-icon').classList.toggle('display-none', !isEditMode);
                editToolbar.classList.toggle('show', isEditMode);
                document.querySelectorAll('.calendar-day').forEach(d => d.classList.toggle('edit-mode-active', isEditMode));
                resetActivityTimeout();
            });

            let activeHandle = null, startX, startY, initialTransformState, scaleCenterX, scaleCenterY, initialDist, activeWidget;
            const applyTransform = (widgetEl, state) => {
                if (!widgetEl || !state) return;
                const { left, top, width, height, scale, visible } = state;
                widgetEl.style.left = `${left}px`;
                widgetEl.style.top = `${top}px`;
                widgetEl.style.width = `${width}px`;
                widgetEl.style.height = `${height}px`;
                widgetEl.style.transform = `scale(${scale})`;
                widgetEl.style.display = visible ? 'flex' : 'none';

                if ((widgetEl.id === 'calendar-container' || widgetEl.id === 'moon-phase-container') && state.height > 0) {
                    widgetEl.querySelector('.background-month').style.fontSize = `${state.height * 0.7}px`;
                    widgetEl.style.fontSize = `${state.height / 40}px`;

                    const titleElement = widgetEl.querySelector('.calendar-title');
                    const headerContainer = widgetEl.querySelector('.calendar-header');
                    const navElement = widgetEl.querySelector('.calendar-nav');

                    if (titleElement && headerContainer && navElement) {
                        headerContainer.getBoundingClientRect();
                        const containerWidth = headerContainer.clientWidth;
                        const navWidth = navElement.offsetWidth;
                        const availableWidth = containerWidth - navWidth - 16;
                        const contentWidth = titleElement.scrollWidth;

                        if (contentWidth > availableWidth && availableWidth > 0) {
                            const currentFontSize = parseFloat(getComputedStyle(widgetEl).fontSize);
                            const newFontSize = currentFontSize * (availableWidth / contentWidth);
                            widgetEl.style.fontSize = `${newFontSize}px`;
                        }
                    }

                } else if (widgetEl.id === 'analog-clock-container') {
                    widgetEl.style.fontSize = `${state.width / 20}px`;
                } else if (widgetEl.classList.contains('marquee-widget')) {
                    widgetEl.style.fontSize = `${state.height * 0.75}px`;
                    const marqueeIndex = parseInt(widgetEl.id.split('-')[2]);
                    MarqueeManager.rebuildAnimationByIndex(marqueeIndex);
                }

                const inverseScale = 1 / scale;
                widgetEl.querySelectorAll('.control-handle').forEach(h => {
                    if (h.classList.contains('move-handle')) h.style.transform = `translate(-50%, -50%) scale(${inverseScale})`;
                    else if (h.classList.contains('resize-handle-w')) h.style.transform = `translateY(-50%) scale(${inverseScale})`;
                    else if (h.classList.contains('resize-handle-h')) h.style.transform = `translateX(-50%) scale(${inverseScale})`;
                });
                const indicator = widgetEl.querySelector('.marquee-edit-indicator');
                if (indicator) indicator.style.transform = `scale(${inverseScale})`;
                widgetEl.style.borderWidth = `${2 * inverseScale}px`;
            };
            const applyAllTransforms = () => { Object.keys(transformStates).forEach(id => applyTransform(document.getElementById(id), transformStates[id])); };
            function checkAndClampWidgetBounds(state) {
                if (!state || !state.visible) return;
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                const renderedWidth = state.width * state.scale;
                const renderedHeight = state.height * state.scale;
                const overflowPercentage = 0.05; 
                const marginW = renderedWidth * overflowPercentage;
                const marginH = renderedHeight * overflowPercentage;
                const clamp = (val, min, max) => Math.max(min, Math.min(val, max));
                const minLeft = -marginW; 
                const maxLeft = winW - renderedWidth + marginW; 
                const minTop = -marginH; 
                const maxTop = winH - renderedHeight + marginH;
                state.left = clamp(state.left, minLeft, maxLeft);
                state.top = clamp(state.top, minTop, maxTop);
            }

            const ensureWidgetsInBounds = () => { Object.values(transformStates).forEach(checkAndClampWidgetBounds); applyAllTransforms(); };
            const onDragStart = (e) => {
                if (!isEditMode) return;
                const targetWidget = e.target.closest('.widget-container');
                if (!targetWidget) return;
                allWidgetContainers().forEach(w => w.style.zIndex = '10');
                targetWidget.style.zIndex = '100';
                e.preventDefault(); e.stopPropagation();
                
                // *** 修正開始：儲存並暫時移除 transition ***
                const originalTransition = targetWidget.style.transition;
                targetWidget.style.transition = 'none';

                activeWidget = { 
                    el: targetWidget, 
                    state: transformStates[targetWidget.id],
                    originalTransition: originalTransition // 儲存原始值
                };
                // *** 修正結束 ***

                const handle = e.target.closest('.control-handle');
                if (handle) {
                    if (handle.classList.contains('move-handle')) activeHandle = 'move';
                    else if (handle.classList.contains('resize-handle-w')) activeHandle = 'resize-w';
                    else if (handle.classList.contains('resize-handle-h')) activeHandle = 'resize-h';
                } else { activeHandle = 'scale'; }
                document.body.style.userSelect = 'none';
                startX = (e.touches ? e.touches[0] : e).clientX;
                startY = (e.touches ? e.touches[0] : e).clientY;
                initialTransformState = { ...activeWidget.state };
                if (activeHandle === 'scale') {
                    const rect = activeWidget.el.getBoundingClientRect();
                    scaleCenterX = rect.left + rect.width / 2;
                    scaleCenterY = rect.top + rect.height / 2;
                    initialDist = Math.hypot(startX - scaleCenterX, startY - scaleCenterY);
                }
                window.addEventListener('mousemove', onDragMove);
                window.addEventListener('touchmove', onDragMove, { passive: false });
                window.addEventListener('mouseup', onDragEnd);
                window.addEventListener('touchend', onDragEnd);
            };

            const onDragMove = (e) => {
                if (!activeHandle || !activeWidget) return;
                e.preventDefault();
                const currentX = (e.touches ? e.touches[0] : e).clientX;
                const currentY = (e.touches ? e.touches[0] : e).clientY;
                const dx = currentX - startX, dy = currentY - startY;
                switch (activeHandle) {
                    case 'move':
                        document.body.style.cursor = 'grabbing';
                        activeWidget.state.left = initialTransformState.left + dx;
                        activeWidget.state.top = initialTransformState.top + dy;
                        break;
                    case 'resize-w':
                        document.body.style.cursor = 'ew-resize';
                        activeWidget.state.width = Math.max(50, initialTransformState.width + dx);
                        if (activeWidget.el.id === 'analog-clock-container') activeWidget.state.height = activeWidget.state.width;
                        else if (activeWidget.el.id === 'led-clock-container' && LedClock.aspectRatio > 0) activeWidget.state.height = activeWidget.state.width / LedClock.aspectRatio;
                        break;
                    case 'resize-h':
                        document.body.style.cursor = 'ns-resize';
                        activeWidget.state.height = Math.max(50, initialTransformState.height + dy);
                        if (activeWidget.el.id === 'analog-clock-container') activeWidget.state.width = activeWidget.state.height;
                        else if (activeWidget.el.id === 'led-clock-container' && LedClock.aspectRatio > 0) activeWidget.state.width = activeWidget.state.height * LedClock.aspectRatio;
                        break;
                    case 'scale':
                        const currentDist = Math.hypot(currentX - scaleCenterX, currentY - scaleCenterY);
                        let newScale = initialDist > 0 ? (initialTransformState.scale * (currentDist / initialDist)) : initialTransformState.scale;
                        const maxScaleX = window.innerWidth / initialTransformState.width;
                        const maxScaleY = window.innerHeight / initialTransformState.height;
                        newScale = Math.max(0.2, Math.min(newScale, Math.min(maxScaleX, maxScaleY, 5)));
                        const oldW = initialTransformState.width * initialTransformState.scale, oldH = initialTransformState.height * initialTransformState.scale;
                        const newW = initialTransformState.width * newScale, newH = initialTransformState.height * newScale;
                        activeWidget.state.left = initialTransformState.left - (newW - oldW) / 2;
                        activeWidget.state.top = initialTransformState.top - (newH - oldH) / 2;
                        activeWidget.state.scale = newScale;
                        document.body.style.cursor = currentDist > initialDist ? 'zoom-in' : 'zoom-out';
                        break;
                }
                checkAndClampWidgetBounds(activeWidget.state);
                applyTransform(activeWidget.el, activeWidget.state);
            };
            const onDragEnd = () => { 
                if (!activeHandle) return;
                
                // *** 修正開始：恢復原始的 transition ***
                if (activeWidget && activeWidget.el) {
                    activeWidget.el.style.transition = activeWidget.originalTransition;
                }
                // *** 修正結束 ***

                ensureWidgetsInBounds(); 
                document.body.style.cursor = 'default'; 
                document.body.style.userSelect = 'auto'; 
                activeHandle = null; 
                activeWidget = null; 
                window.removeEventListener('mousemove', onDragMove); 
                window.removeEventListener('touchmove', onDragMove); 
                window.removeEventListener('mouseup', onDragEnd); 
                window.removeEventListener('touchend', onDragEnd); 
                saveCurrentSettings(); 
            };
            document.body.addEventListener('mousedown', onDragStart); document.body.addEventListener('touchstart', onDragStart, { passive: false });
            // ===================================================================
            // 版面配置儲存/載入
            // ===================================================================
            const getCurrentLayout = () => ({ transforms: transformStates, settings: settingsState });
            const applyLayout = (layout) => {
                if (layout.transforms) transformStates = { ...transformStates, ...layout.transforms };
                if (layout.settings) {
                    Object.keys(layout.settings).forEach(key => {
                        if (key === 'marquees' && Array.isArray(layout.settings[key])) {
                            settingsState[key] = layout.settings[key].map(m => {
                                if (typeof m.color === 'string' && !m.colors) {
                                    const newMarquee = {...m, colors: {default: m.color}};
                                    delete newMarquee.color;
                                    return newMarquee;
                                }
                                return m;
                            });
                        } else if (typeof layout.settings[key] === 'object' && !Array.isArray(layout.settings[key]) && layout.settings[key] !== null) {
                            settingsState[key] = { ...(settingsState[key] || {}), ...layout.settings[key] };
                        } else {
                            settingsState[key] = layout.settings[key];
                        }
                    });
                }
                applyAllSettings();
            };

            const toolbarTitle = document.getElementById('toolbar-title');
            let toolbarMoving = false, toolbarOffsetX, toolbarOffsetY;

            const handleToolbarDragStart = (e) => { e.preventDefault(); toolbarMoving = true; const rect = editToolbar.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; toolbarOffsetX = clientX - rect.left; toolbarOffsetY = clientY - rect.top; editToolbar.style.transition = 'none'; };
            const handleToolbarDragMove = (e) => { if (!toolbarMoving) return; const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; let x = clientX - toolbarOffsetX; let y = clientY - toolbarOffsetY; const rect = editToolbar.getBoundingClientRect(); x = Math.max(0, Math.min(x, window.innerWidth - rect.width)); y = Math.max(0, Math.min(y, window.innerHeight - rect.height)); editToolbar.style.left = `${x}px`; editToolbar.style.top = `${y}px`; editToolbar.style.bottom = 'auto'; editToolbar.style.transform = 'none'; };
            const handleToolbarDragEnd = () => { if (toolbarMoving) { toolbarMoving = false; editToolbar.style.transition = 'bottom 0.3s ease-in-out'; } };
            toolbarTitle.addEventListener('mousedown', handleToolbarDragStart);
            toolbarTitle.addEventListener('touchstart', handleToolbarDragStart, { passive: false });
            document.addEventListener('mousemove', handleToolbarDragMove);
            document.addEventListener('touchmove', handleToolbarDragMove, { passive: false });
            document.addEventListener('mouseup', handleToolbarDragEnd);
            document.addEventListener('touchend', handleToolbarDragEnd);
            const layoutSelector=document.getElementById('layout-selector');
            function updateLayoutSelector(){layoutSelector.innerHTML='';for(let i=0;i<10;i++){const saved=localStorage.getItem(`widgets_layout_${i}`);const option=document.createElement('option');option.value=i;let text=`${i+1}. (空)`;if(saved){const data=JSON.parse(saved);
            text=`${i+1}. ${data.name||'未命名'}`}option.textContent=text;layoutSelector.appendChild(option)}}
            document.getElementById('save-layout-btn').addEventListener('click',()=>{const index=layoutSelector.value;const saved=localStorage.getItem(`widgets_layout_${index}`);const currentName=saved?JSON.parse(saved).name:'';showPrompt("儲存設定","請輸入備註 (可選):",currentName,(remark)=>{if(remark===null)return;const layout=getCurrentLayout();layout.name=remark.trim()||new Date().toLocaleString('sv').replace(' ','_');localStorage.setItem(`widgets_layout_${index}`,JSON.stringify(layout));const currentIndex=layoutSelector.value;updateLayoutSelector();layoutSelector.value=currentIndex;showAlert("成功",`設定已儲存至欄位 ${parseInt(index)+1}`)})});
            document.getElementById('load-layout-btn').addEventListener('click',()=>{const savedLayout=localStorage.getItem(`widgets_layout_${layoutSelector.value}`);if(savedLayout){applyLayout(JSON.parse(savedLayout));saveCurrentSettings()}else{showAlert('提示','此欄位沒有儲存設定。')}});
            document.getElementById('export-layout-btn').addEventListener('click',()=>{try{const settings={};let hasSettings=false;for(let i=0;i<10;i++){const saved=localStorage.getItem(`widgets_layout_${i}`);if(saved){settings[i]=JSON.parse(saved);hasSettings=true}}if(!hasSettings)return showAlert("提示","沒有可導出的設定！");const blob=new Blob([JSON.stringify(settings,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`widgets_settings_${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(a.href)}catch(error){showAlert("錯誤","導出設定時發生錯誤。")}});
            document.getElementById('import-layout-btn').addEventListener('click',()=>{const input=document.createElement('input');input.type='file';input.accept='.json';input.onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=e=>{try{const settings=JSON.parse(e.target.result);let count=0;for(let i=0;i<10;i++){if(settings[i]&&settings[i].name&&settings[i].transforms){localStorage.setItem(`widgets_layout_${i}`,JSON.stringify(settings[i]));count++}}updateLayoutSelector();showAlert("成功",`成功導入 ${count} 組設定！`)}catch(err){showAlert('錯誤','導入失敗，檔案格式錯誤！')}};reader.readAsText(file)};input.click()});

            // ===================================================================
            // 地區選擇器
            // ===================================================================
            const countySelect = document.getElementById('countySelect'), districtSelect = document.getElementById('districtSelect'), manualLocationInput = document.getElementById('manualLocationInput');
            Object.keys(taiwanLocations).forEach(county => countySelect.add(new Option(county, county)));
            function updateDistrictOptions() { districtSelect.innerHTML = ''; const districts = taiwanLocations[countySelect.value]?.districts || {}; Object.keys(districts).forEach(dist => districtSelect.add(new Option(dist, dist))); }
            function updateLocationSelectors() { const loc = settingsState.location; manualLocationInput.value = loc; for (const county in taiwanLocations) { for (const district in taiwanLocations[county].districts) { if (taiwanLocations[county].districts[district].toLowerCase() === loc.toLowerCase()) { countySelect.value = county; updateDistrictOptions(); districtSelect.value = district; return; } } } countySelect.selectedIndex = 0; updateDistrictOptions(); }
            function handleLocationChange(newLocation) { settingsState.location = newLocation; manualLocationInput.value = newLocation; Weather.updateWeather(); saveCurrentSettings(); }
            countySelect.addEventListener('change', () => { updateDistrictOptions(); handleLocationChange(taiwanLocations[countySelect.value].districts[districtSelect.value]); });
            districtSelect.addEventListener('change', () => { handleLocationChange(taiwanLocations[countySelect.value].districts[districtSelect.value]); });
            manualLocationInput.addEventListener('change', () => { handleLocationChange(manualLocationInput.value.trim()); });
            document.getElementById('useCurrentLocationBtn').addEventListener('click', () => { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=en`).then(r => r.json()).then(geo => { const city = geo.locality || geo.city; if (city) { handleLocationChange(city); updateLocationSelectors(); } }); }); } });

            // ===================================================================
            // 定時特效設定
            // ===================================================================
            function setupTimedEffectControls() {
                const effectEnabled = document.getElementById('timed-effect-enabled-toggle');
                const effectInterval = document.getElementById('timed-effect-interval-seconds');

                [10, 15, 20, 30, 60].forEach(val => {
                    effectInterval.add(new Option(String(val), val));
                });

                const updateSetting = () => {
                    if (!settingsState.timedEffect) {
                        settingsState.timedEffect = JSON.parse(JSON.stringify(userDefaultLayout.settings.timedEffect));
                    }
                    settingsState.timedEffect.enabled = effectEnabled.checked;
                    settingsState.timedEffect.intervalSeconds = parseInt(effectInterval.value, 10);
                    saveCurrentSettings();
                };

                effectEnabled.addEventListener('change', updateSetting);
                effectInterval.addEventListener('change', updateSetting);
            }

            // ===================================================================
            // 應用程式初始化
            // ===================================================================
            (function initializeApp() {
                MarqueeManager.init();
                const autoSavedLayout = localStorage.getItem('widgets_autosave');
                if (autoSavedLayout) {
                    const parsed = JSON.parse(autoSavedLayout);
                    if (!parsed.settings || !parsed.settings.marquees || !parsed.transforms) {
                        applyLayout(JSON.parse(JSON.stringify(userDefaultLayout)));
                    } else {
                        const urlParams = new URLSearchParams(window.location.search);
                        const layoutParam = urlParams.get('layout');
                        if (layoutParam) {
                            try {
                                const decodedLayout = JSON.parse(atob(layoutParam));
                                if (decodedLayout.transforms) {
                                    applyLayout({ transforms: decodedLayout.transforms, settings: parsed.settings });
                                } else { applyLayout(parsed); }
                            } catch(e) { console.error("無法解析傳入的版面配置資訊", e); applyLayout(parsed); }
                        } else { applyLayout(parsed); }
                    }
                } else {
                    applyLayout(JSON.parse(JSON.stringify(userDefaultLayout)));
                }
                Calendar.init();
                LedClock.init();
                AnalogClock.init();
                Weather.init();
                MoonPhaseWidget.init();
                setupTimedEffectControls();
                resetActivityTimeout();
                updateLayoutSelector();
                saveCurrentSettings(); 
                window.addEventListener('resize', () => { ensureWidgetsInBounds(); MarqueeManager.rebuildAllAnimations(); saveCurrentSettings(); });
                document.fonts.ready.then(() => { ensureWidgetsInBounds(); MarqueeManager.rebuildAllAnimations(); });
            })();
        });

            const lunarInfo=[0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0,0x04950,0x097b8,0x04950,0x0b4a0,0x0b6a6,0x06d40,0x0ab50,0x052f4,0x052f0,0x0a960,0x0e964,0x0d4a0,0x0da50,0x1d552,0x056a0,0x096d0,0x055b5,0x049b0,0x0a5b0,0x0a4b5,0x0a4b0,0x1b25a,0x06d20,0x0ada0,0x14950,0x095b0,0x04977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5];
            const nStr1="日一二三四五六七八九十";const nStr2="初十廿卅"; const tiangan = "甲乙丙丁戊己庚辛壬癸"; const dizhi = "子丑寅卯辰巳午未申酉戌亥"; const shengxiao = "鼠牛虎兔龍蛇馬羊猴雞狗豬";
            const moonPhaseData={1:{n:'朔月',a:'新月',d:'月球位於日地之間，黑暗面朝向地球，不可見。'},2:{n:'既朔月',d:'新月之後，可見極細彎月。'},3:{n:'蛾眉新月',d:'月牙兒逐漸變寬，形如秀眉。'},4:{n:'蛾眉月',d:''},5:{n:'蛾眉月',d:''},6:{n:'夕月',d:'日落後不久即可在西方天空看到。'},7:{n:'上弦月',d:'可見月球被照亮的一半，形如字母 "D"。'},8:{n:'上弦月',d:''},9:{n:'九夜月',d:''},10:{n:'宵月',d:'夜晚大部分時間都能看到月亮。'},11:{n:'漸盈凸月',d:'月相接近圓滿。'},12:{n:'漸盈凸月',d:''},13:{n:'漸盈凸月',d:''},14:{n:'小望月',d:'距離滿月僅一步之遙。'},15:{n:'望月',a:'滿月',d:'地球位於日月之間，可見完整的月盤。'},16:{n:'既望月',d:'滿月之後，月亮開始由盈轉虧。'},17:{n:'立待月',d:'月出稍晚，需站著等待。'},18:{n:'居待月',d:'月出更晚，可坐著等待。'},19:{n:'寢待月',d:'月亮升起時已近睡覺時間。'},20:{n:'更待月',d:'月亮在深夜一更後升起。'},21:{n:'漸虧凸月',d:'可見部分減少，但仍大於一半。'},22:{n:'下弦月',d:'再次看到一半，形如反向 "D"。'},23:{n:'下弦月',d:''},24:{n:'有明月',d:'天將亮時，仍可見月亮。'},25:{n:'蛾眉殘月',d:'月相變回鐮刀形。'},26:{n:'蛾眉殘月',d:''},27:{n:'殘月',d:'月牙兒更細。'},28:{n:'殘月',d:''},29:{n:'曉月',d:'僅在黎明前短暫可見。'},30:{n:'晦月',d:'月亮完全消失，為農曆月結束。'}};
            const explanations = {"春節":"農曆新年的第一天，是華人最盛大的傳統節日。","元宵節":"農曆正月十五，又稱上元節。","端午節":"農曆五月初五，為紀念愛國詩人屈原的節日。","七夕":"農曆七月初七，又稱情人節。","中元節":"農曆七月十五，祭祀祖先、普渡孤魂的日子。","中秋節":"農曆八月十五，是家人團圓的日子。","除夕":"農曆年的最後一天。家人會在這天團聚吃年夜飯。","元旦":"公曆新年的第一天。","情人節":"西方的傳統節日，情侶們會在這天互贈禮物。","和平紀念日":"紀念1947年2月28日發生的二二八事件。","婦女節":"為慶祝婦女在經濟、政治和社會等領域做出的重要貢獻而設立的節日。","植樹節":"為激發人們愛林、造林的熱情，促進國土綠化而設立的節日。","愚人節":"在每年4月1日，人們習慣以各種方式互相欺騙、捉弄及取笑。","兒童節":"為保障兒童的權利而設立的節日。","勞動節":"對勞動者表示尊重和慶祝的日子。","母親節":"感謝母親的節日，通常在每年五月的第二個星期日。","父親節":"感謝父親的節日，訂於每年的八月八日。","國際父親節":"許多國家感謝父親的節日，訂於每年六月的第三個星期日。","軍人節":"紀念軍人對國家的貢獻與犧牲。","教師節":"感謝老師教導的節日。","國慶日":"紀念武昌起義，中華民國的國定假日。","台灣光復節":"紀念台灣在1945年10月25日結束日本統治。","萬聖夜":"在每年的10月31日，小孩會裝扮成各種鬼怪討糖果。","國父誕辰":"紀念中華民國國父孫中山先生的生日。","感恩節":"北美地區感謝豐收的傳統節日，在美國為十一月的第四個星期四。","平安夜":"聖誕節前夕，即12月24日夜晚。","聖誕節":"紀念耶穌基督誕生的日子。","跨年夜":"指元旦前一晚，即12月31日夜晚。","天公生":"農曆正月初九，玉皇大帝的誕辰。","土地公生":"農曆二月初二，為土地公（福德正神）的誕辰。","媽祖誕辰":"農曆三月二十三，是海上守護神媽祖的生日。","重陽節":"農曆九月初九，有登高、賞菊、敬老的習俗。","下元節":"農曆十月十五，是為水官解厄之辰。","臘八節":"農曆十二月初八，傳統上會喝臘八粥。","送神日":"農曆十二月二十四，送眾神明回天庭述職的日子。","立春":"春季的開始。","雨水":"降雨開始，雨量漸增。","驚蟄":"春雷始鳴，驚醒蟄伏的昆蟲。","春分":"晝夜等長的日子。","清明":"天氣轉暖，掃墓祭祖的傳統節日。","穀雨":"雨水增多，有利於穀類作物的生長。","立夏":"夏季的開始。","小滿":"農作物子粒開始灌漿飽滿。","芒種":"麥類等有芒作物成熟，夏種開始。","夏至":"北半球白晝最長的一天。","小暑":"天氣開始炎熱。","大暑":"一年中最熱的時期。","立秋":"秋季的開始。","處暑":"炎熱的夏天即將過去。","白露":"天氣轉涼，清晨的露水日益加重。","秋分":"晝夜等長的日子。","寒露":"氣溫更低，露水有寒意。","霜降":"天氣漸冷，開始有霜。","立冬":"冬季的開始。","小雪":"開始下雪，但雪量不大。","大雪":"降雪量增大，地面可能會有積雪。","冬至":"北半球白晝最短的一天。","小寒":"氣候開始寒冷。","大寒":"一年中最寒冷的時期。"};
            const lunarHolidays={"1-1":"春節","1-9":"天公生","1-15":"元宵節","2-2":"土地公生","3-23":"媽祖誕辰","5-5":"端午節","7-7":"七夕","7-15":"中元節","8-15":"中秋節","9-9":"重陽節","10-15":"下元節","12-8":"臘八節","12-24":"送神日","12-30":"除夕"};
            const gregorianHolidays = {"1-1":"元旦","2-14":"情人節","2-28":"和平紀念日","3-8":"婦女節","3-12":"植樹節","4-1":"愚人節","4-4":"兒童節","5-1":"勞動節","8-8":"父親節","9-3":"軍人節","9-28":"教師節","10-10":"國慶日","10-25":"台灣光復節","10-31":"萬聖夜","11-12":"國父誕辰","12-24":"平安夜","12-25":"聖誕節","12-31":"跨年夜"};            const solarTermConstants=[["小寒",1,5.4055],["大寒",1,20.12],["立春",2,3.87],["雨水",2,18.73],["驚蟄",3,5.63],["春分",3,20.646],["清明",4,4.81],["穀雨",4,20.1],["立夏",5,5.52],["小滿",5,21.04],["芒種",6,5.678],["夏至",6,21.37],["小暑",7,7.108],["大暑",7,22.83],["立秋",8,7.5],["處暑",8,23.13],["白露",9,7.646],["秋分",9,23.042],["寒露",10,8.318],["霜降",10,23.438],["立冬",11,7.438],["小雪",11,22.36],["大雪",12,7.18],["冬至",12,21.94]];
            const floatingHolidays = {"5-2-0":"母親節","6-3-0":"國際父親節","11-4-4":"感恩節"};
            const taiwanLocations = { "台灣": { "english": "taiwan", "districts": { "台灣": "taiwan" } }, "基隆市": { "english": "keelung", "districts": { "基隆市": "keelung", "仁愛區": "renai", "信義區": "xinyi", "中正區": "zhongzheng", "中山區": "zhongshan", "安樂區": "anle", "暖暖區": "nuannuan", "七堵區": "qidu" } }, "臺北市": { "english": "taipei", "districts": { "臺北市": "taipei", "中正區": "zhongzheng", "大同區": "datong", "中山區": "zhongshan", "松山區": "songshan", "大安區": "da'an", "萬華區": "wanhua", "信義區": "xinyi", "士林區": "shilin", "北投區": "beitou", "內湖區": "neihu", "南港區": "nangang", "文山區": "wenshan" } }, "新北市": { "english": "new taipei", "districts": { "新北市": "new taipei", "板橋區": "banqiao", "三重區": "sanchong", "中和區": "zhonghe", "永和區": "yonghe", "新莊區": "xinzhuang", "新店區": "xindian", "土城區": "tucheng", "蘆洲區": "luzhou", "樹林區": "shulin", "汐止區": "xizhi", "鶯歌區": "yingge", "三峽區": "sanxia", "淡水區": "danshui", "瑞芳區": "ruifang", "五股區": "wugu", "泰山區": "taishan", "林口區": "linkou", "深坑區": "shengkeng", "石碇區": "shiding", "坪林區": "pinglin", "三芝區": "sanzhi", "石門區": "shimen", "八里區": "bali", "平溪區": "pingxi", "雙溪區": "shuangxi", "貢寮區": "gongliao", "金山區": "jinshan", "萬里區": "wanli", "烏來區": "wulai" } }, "桃園市": { "english": "taoyuan", "districts": { "桃園市": "taoyuan", "桃園區": "taoyuan", "中壢區": "zhongli", "平鎮區": "pingzhen", "八德區": "bade", "楊梅區": "yangmei", "蘆竹區": "luzhu", "大溪區": "daxi", "龍潭區": "longtan", "龜山區": "guishan", "大園區": "dayuan", "觀音區": "guanyin", "新屋區": "xinwu", "復興區": "fuxing" } }, "臺中市": { "english": "taichung", "districts": { "臺中市": "taichung", "中區": "central", "東區": "east", "南區": "south", "西區": "west", "北區": "north", "北屯區": "beitun", "西屯區": "xitun", "南屯區": "nantun", "太平區": "taiping", "大里區": "dali", "霧峰區": "wufeng", "烏日區": "wuri", "豐原區": "fengyuan", "后里區": "houli", "石岡區": "shigang", "東勢區": "dongshi", "和平區": "heping", "新社區": "xinshe", "潭子區": "tanzi", "大雅區": "daya", "神岡區": "shengang", "大肚區": "dadu", "沙鹿區": "shalu", "龍井區": "longjing", "梧棲區": "wuqi", "清水區": "qingshui", "大甲區": "dajia", "外埔區": "waipu", "大安區": "daan" } }, "臺南市": { "english": "tainan", "districts": { "臺南市": "tainan", "中西區": "west central", "東區": "east", "南區": "south", "北區": "north", "安平區": "anping", "安南區": "annan", "永康區": "yongkang", "歸仁區": "guiren", "新化區": "xinhua", "左鎮區": "zuozhen", "玉井區": "yujing", "楠西區": "nanxi", "南化區": "nanhua", "仁德區": "rende", "關廟區": "guanmiao", "龍崎區": "longqi", "官田區": "guantian", "麻豆區": "madou", "佳里區": "jiali", "西港區": "xigang", "七股區": "qigu", "將軍區": "jiangjun", "學甲區": "xuejia", "北門區": "beimen", "新營區": "xinying", "後壁區": "houbi", "白河區": "baihe", "東山區": "dongshan", "六甲區": "liujia", "下營區": "xiaying", "柳營區": "liuying", "鹽水區": "yanshui", "善化區": "shanhua", "大內區": "danei", "山上區": "shanshang", "新市區": "xingshi", "安定區": "anding" } }, "高雄市": { "english": "kaohsiung", "districts": { "高雄市": "kaohsiung", "楠梓區": "nanzi", "左營區": "zuoying", "鼓山區": "gushan", "三民區": "sanmin", "鹽埕區": "yancheng", "前金區": "qianjin", "新興區": "xinxing", "苓雅區": "lingya", "前鎮區": "qianzhen", "旗津區": "qijin", "小港區": "xiaogang", "鳳山區": "fengshan", "林園區": "linyuan", "大寮區": "daliao", "大樹區": "dashu", "大社區": "dashe", "仁武區": "renwu", "鳥松區": "niaosong", "岡山區": "gangshan", "橋頭區": "qiaotou", "燕巢區": "yanchao", "田寮區": "tianliao", "阿蓮區": "alian", "路竹區": "luzhu", "湖內區": "hunei", "茄萣區": "qieding", "永安區": "yong'an", "彌陀區": "mizuo", "梓官區": "ziguan", "旗山區": "qishan", "美濃區": "meinong", "六龜區": "liugui", "甲仙區": "jiaxian", "杉林區": "shanlin", "內門區": "neimen", "茂林區": "maolin", "桃源區": "taoyuan", "那瑪夏區": "namasia" } }, "新竹縣": { "english": "hsinchu county", "districts": { "新竹縣": "hsinchu county", "竹北市": "zhubei", "竹東鎮": "zhudong", "新埔鎮": "xinpu", "關西鎮": "guanxi", "湖口鄉": "hukou", "新豐鄉": "xinfeng", "芎林鄉": "qionglin", "橫山鄉": "hengshan", "北埔鄉": "beipu", "寶山鄉": "baoshan", "峨眉鄉": "emei", "尖石鄉": "jianshi", "五峰鄉": "wufeng" } }, "苗栗縣": { "english": "miaoli", "districts": { "苗栗縣": "miaoli", "苗栗市": "miaoli city", "頭份市": "toufen", "苑裡鎮": "yuanli", "通霄鎮": "tongxiao", "竹南鎮": "zhunan", "後龍鎮": "houlong", "卓蘭鎮": "zhuolan", "大湖鄉": "dahu", "公館鄉": "gongguan", "銅鑼鄉": "tongluo", "南庄鄉": "nanzhuang", "頭屋鄉": "touwu", "三灣鄉": "sanwan", "三義鄉": "sanyi", "西湖鄉": "xihu", "造橋鄉": "zaoqiao", "獅潭鄉": "shitan", "泰安鄉": "taian" } }, "彰化縣": { "english": "changhua", "districts": { "彰化縣": "changhua", "彰化市": "changhua city", "員林市": "yuanlin", "和美鎮": "hemei", "鹿港鎮": "lukang", "溪湖鎮": "xihu", "田中鎮": "tianzhong", "北斗鎮": "beidou", "二林鎮": "erlin", "線西鄉": "xianxi", "伸港鄉": "shengang", "福興鄉": "fuxing", "秀水鄉": "xiushui", "花壇鄉": "huatan", "芬園鄉": "fenyuan", "大村鄉": "dacun", "埔鹽鄉": "puyan", "埔心鄉": "puxin", "永靖鄉": "yongjing", "社頭鄉": "shetou", "二水鄉": "ershui", "田尾鄉": "tianwei", "埤頭鄉": "pitou", "芳苑鄉": "fangyuan", "大城鄉": "dacheng", "竹塘鄉": "zhutang", "溪州鄉": "xizhou" } }, "南投縣": { "english": "nantou", "districts": { "南投縣": "nantou", "南投市": "nantou city", "埔里鎮": "puli", "草屯鎮": "caotun", "竹山鎮": "zhushan", "集集鎮": "jiji", "名間鄉": "mingjian", "鹿谷鄉": "lugu", "中寮鄉": "zhongliao", "魚池鄉": "yuchi", "國姓鄉": "guoxing", "水里鄉": "shuili", "信義鄉": "xinyi", "仁愛鄉": "ren'ai" } }, "雲林縣": { "english": "yunlin", "districts": { "雲林縣": "yunlin", "斗六市": "douliu", "斗南鎮": "dounan", "虎尾鎮": "huwei", "西螺鎮": "xiluo", "土庫鎮": "tuku", "北港鎮": "beigang", "古坑鄉": "gukeng", "大埤鄉": "dapi", "莿桐鄉": "citong", "林內鄉": "linnei", "二崙鄉": "erlun", "崙背鄉": "lunbei", "麥寮鄉": "mailiao", "東勢鄉": "dongshi", "褒忠鄉": "baozhong", "臺西鄉": "taixi", "元長鄉": "yuanchang", "四湖鄉": "sihu", "口湖鄉": "kouhu", "水林鄉": "shuilin" } }, "嘉義縣": { "english": "chiayi county", "districts": { "嘉義縣": "chiayi county", "太保市": "taibao", "朴子市": "puzi", "布袋鎮": "budai", "大林鎮": "dalin", "民雄鄉": "minxiong", "溪口鄉": "xikou", "新港鄉": "xingang", "六腳鄉": "liujiao", "東石鄉": "dongshi", "義竹鄉": "yizu", "鹿草鄉": "lucao", "水上鄉": "shuishang", "中埔鄉": "zhongpu", "竹崎鄉": "zhuqi", "梅山鄉": "meishan", "番路鄉": "fanlu", "大埔鄉": "dapu", "阿里山鄉": "alishan" } }, "屏東縣": { "english": "pingtung", "districts": { "屏東縣": "pingtung", "屏東市": "pingtung city", "潮州鎮": "chaozhou", "東港鎮": "donggang", "恆春鎮": "hengchun", "萬丹鄉": "wandan", "長治鄉": "changzhi", "麟洛鄉": "linluo", "九如鄉": "jiuru", "里港鄉": "ligang", "鹽埔鄉": "yanpu", "高樹鄉": "gaoshu", "萬巒鄉": "wanluan", "內埔鄉": "neipu", "竹田鄉": "zhutian", "新埤鄉": "xinpi", "枋寮鄉": "fangliao", "新園鄉": "xinyuan", "崁頂鄉": "kanding", "林邊鄉": "linbian", "南州鄉": "nanzhou", "佳冬鄉": "jiadong", "琉球鄉": "liuqiu", "車城鄉": "checheng", "滿州鄉": "manzhou", "枋山鄉": "fangshan", "三地門鄉": "sandimen", "霧臺鄉": "wutai", "瑪家鄉": "majia", "泰武鄉": "taiwu", "來義鄉": "laiyi", "春日鄉": "chunri", "獅子鄉": "shizi", "牡丹鄉": "mudan" } }, "宜蘭縣": { "english": "yilan", "districts": { "宜蘭縣": "yilan", "宜蘭市": "yilan city", "羅東鎮": "luodong", "蘇澳鎮": "su'ao", "頭城鎮": "toucheng", "礁溪鄉": "jiaoxi", "壯圍鄉": "zhuangwei", "員山鄉": "yuanshan", "冬山鄉": "dongshan", "五結鄉": "wujie", "三星鄉": "sanxing", "大同鄉": "datong", "南澳鄉": "nan'ao" } }, "花蓮縣": { "english": "hualien", "districts": { "花蓮縣": "hualien", "花蓮市": "hualien city", "鳳林鎮": "fenglin", "玉里鎮": "yuli", "新城鄉": "xincheng", "吉安鄉": "ji'an", "壽豐鄉": "shoufeng", "光復鄉": "guangfu", "豐濱鄉": "fengbin", "瑞穗鄉": "ruisui", "富里鄉": "fuli", "秀林鄉": "xiulin", "萬榮鄉": "wanrong", "卓溪鄉": "zhuoxi" } }, "臺東縣": { "english": "taitung", "districts": { "臺東縣": "taitung", "臺東市": "taitung city", "成功鎮": "chenggong", "關山鎮": "guanshan", "卑南鄉": "beinan", "鹿野鄉": "luye", "池上鄉": "chishang", "東河鄉": "donghe", "長濱鄉": "changbin", "太麻里鄉": "taimali", "大武鄉": "dawu", "達仁鄉": "daren", "金峰鄉": "jinfeng", "海端鄉": "haiduan", "延平鄉": "yanping", "綠島鄉": "ludao", "蘭嶼鄉": "lanyu" } }, "澎湖縣": { "english": "penghu", "districts": { "澎湖縣": "penghu", "馬公市": "magong", "湖西鄉": "huxi", "白沙鄉": "baisha", "西嶼鄉": "xiyu", "望安鄉": "wang'an", "七美鄉": "qimei" } }, "金門縣": { "english": "kinmen", "districts": { "金門縣": "kinmen", "金城鎮": "jincheng", "金湖鎮": "jinhu", "金沙鎮": "jinsha", "金寧鄉": "jinning", "烈嶼鄉": "lieyu", "烏坵鄉": "wuqiu" } }, "連江縣": { "english": "lienchiang", "districts": { "連江縣": "lienchiang", "南竿鄉": "nangan", "北竿鄉": "beigan", "莒光鄉": "juguang", "東引鄉": "dongyin" } }, "新竹市": { "english": "hsinchu", "districts": { "新竹市": "hsinchu", "東區": "east", "北區": "north", "香山區": "xiangshan" } }, "嘉義市": { "english": "chiayi", "districts": { "嘉義市": "chiayi", "東區": "east", "西區": "west" } } };
    </script>
</body>
</html>
